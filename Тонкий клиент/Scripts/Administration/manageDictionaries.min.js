var dictionaryStrings=function(){return{noDataText:"Отсутствуют данные для отображения",dictionaryColumnName:"Наименование",rootBreadcrumbName:"Все справочники",subdictionariesSelectDialogTitle:"Подчиненные словари",subdictionariesSelectDialogOk:"Выбрать",subdictionariesSelectDialogCancel:"Отмена",deleteItemConfirmDialogText:"Вы уверены, что хотите удалить элемент?",deleteItemConfirmDialogOk:"Да",deleteItemConfirmDialogCancel:"Нет",customEditFormTitle:"Редактирование элемента",customEditFormSaveText:"Сохранить",customEditFormCancelText:"Отмена",customEditFormSavingText:"Сохранение...",customEditFormLoadingText:"Загрузка..."}}(),StateManager=function(){function n(){}return n.prototype={getState:function(){var t=window.location,n;return t.hash&&t.hash!==""?(n=t.hash.substring(1),n=decodeURIComponent(n),JSON.parse(n)):this.getInitialState()},setState:function(n){var t=window.location,i=encodeURIComponent(JSON.stringify(n));t.hash=i},getInitialState:function(){return{d:null,s:[],p:[]}},getBreadcrumpsItems:function(){var n=this.getState(),i=[{name:dictionaryStrings.rootBreadcrumbName,state:{d:null,p:[],s:[]}}],r,t,u;for(n.d&&n.d!==""&&i.push({name:n.d,state:{d:n.d,p:[],s:[]}}),r=n.s.length,t=0;t<r;t++)u=n.s[t],i.push({name:u+"("+n.p[t].code+")",state:{d:n.d,p:n.p.slice(0,t+1),s:n.s.slice(0,t+1)}});return i},toQueryString:function(n){n||(n=this.getState());var t=$.map(n.s,function(n){return"&subDictionaryNames="+encodeURIComponent(n)});return t.length===0&&t.push("&subDictionaryNames="),"?dictionaryName="+encodeURIComponent(n.d)+t.join("")+"&parent="+(n.p.length>0?n.p[n.p.length-1].key:null)}},{createInstance:function(){return new n}}}(),dictApi=function(){function t(t){var i=r(t);return n(i),i}function i(t,i){var r=u(t,i);return n(r),r}function n(n){return waitingDialog.showWaiting(),n.always(function(){waitingDialog.hide()})}function r(n){var t=jQuery.Deferred();return $.ajax({url:n,type:"GET",contentType:!1,cache:!1,processData:!1}).then(function(n){var i=JSON.parse(n);i.status==="OK"?(i=JSON.parse(i.responseMessage),t.resolve(i)):(showCommonErrors([i.responseMessage]),t.reject(i.responseMessage))},function(n){showCommonErrors([n.responseText]);t.reject(n.responseText)}),t.promise()}function u(n,t){var i=jQuery.Deferred(),r=new FormData;return $.each(t,function(n,t){r.append(n,t)}),$.ajax({url:n,type:"POST",mimeType:"multipart/form-data",cache:!1,data:r,contentType:!1,cache:!1,processData:!1}).then(function(n){var t=JSON.parse(n);t.status==="OK"?i.resolve():(showCommonErrors([t.responseMessage]),i.reject(t.responseMessage))},function(n){showCommonErrors([n.responseText]);i.reject(n.responseText)}),i.promise()}return{callApi:t,postApi:i}}(),dataSourceFactory=function(){function n(n){var i=n.getState(),t=n.toQueryString(i),r=getRelativeUrl("/Administration/GetDictionaryItems")+t,u=getRelativeUrl("/Administration/RemoveDictionaryItem")+t,f=getRelativeUrl("/Administration/UpdateDictionaryItem")+t,e=getRelativeUrl("/Administration/AddDictionaryItem")+t;return DevExpress.data.AspNet.createStore({key:"key",loadUrl:r,deleteUrl:u,deleteMethod:"POST",updateUrl:f,updateMethod:"POST",insertUrl:e,insertMethod:"POST"})}return{createDictionaryStore:n}}(),actionBuilder=function(){function t(t,f,e){var h=f.customForm&&f.customForm.trim()!=="",o,s,c;h?f.canCreate?t.option("onToolbarPreparing",function(i){var r=i.toolbarOptions.items;r.push({widget:"dxButton",options:{icon:"add",onClick:function(){n(e.getState().d,"",f.customForm).then(function(n){t.beginUpdate();t.addRow();t.endUpdate();t.beginUpdate();$.each(n,function(n,i){t.cellValue(0,n,i)});t.endUpdate();t.saveEditData().then(function(){},function(){t.deleteRow(0)})},function(){})}},location:"after"})}):t.option("onToolbarPreparing",function(n){n.toolbarOptions.items.pop()}):(o=t.option("editing"),o.mode="form",o.allowAdding=f.canCreate,t.option("editing",o),t.option("onToolbarPreparing",null));s=t.option("columns");c=u(t,f.canDelete,f.canEdit?function(n,t){h?r(n,t,e.getState().d,f.customForm):i(n,t)}:null);s.push(c);t.option("columns",s)}function i(n,t){n.editRow(t.rowIndex)}function r(t,i,r,u){n(r,i.data.key,u).then(function(n){t.beginUpdate();$.each(n,function(n,r){t.cellValue(i.rowIndex,n,r)});t.saveEditData();t.endUpdate()},function(){})}function u(n,t,i){return{caption:"",allowEditing:!1,formItem:{visible:!1},width:100,cellTemplate:function(r,u){var e=$("<div class='dx-command-edit dictionary-item-commands'><\/div>"),o,s;return i&&(o=$("<div/>").dxButton({icon:"edit",type:"normal",onClick:function(t){t.event.stopPropagation();i(n,u)}}),e.append(o)),t&&(s=$("<div/>").dxButton({icon:"remove",type:"normal",onClick:function(t){t.event.stopPropagation();f().then(function(){n.deleteRow(u.rowIndex)})}}),e.append(s)),e}}}function f(){var t=jQuery.Deferred(),i=$("<div>"),n;return $("body").append(i),n=i.dxPopup({width:320,height:135,showTitle:!1,position:"center",resizeEnabled:!1,visible:!1,showCloseButton:!1,contentTemplate:function(i){var u=$("<p/>").text(dictionaryStrings.deleteItemConfirmDialogText),r=$("<div />").addClass("popup-buttons-container").css("width","200px");r.append($("<div />").addClass("popup-button").dxButton({stylingMode:"contained",text:dictionaryStrings.deleteItemConfirmDialogOk,onClick:function(){t.resolve();n.hide()}}),$("<div />").addClass("popup-button").dxButton({stylingMode:"contained",text:dictionaryStrings.deleteItemConfirmDialogCancel,onClick:function(){t.reject();n.hide()}}));i.append($("<div />"),u,r)}}).dxPopup("instance"),n.show(),t.promise()}function n(n,t,i){var f=getRelativeUrl("/Dictionary/GetDictionaryForm")+"?name="+encodeURIComponent(n)+"&template="+encodeURIComponent(i)+"&key="+t,e=jQuery.Deferred(),u=$("<div>"),r,o;$("body").append(u);r=u.dxPopup({title:dictionaryStrings.customEditFormTitle,position:"center",resizeEnabled:!1,visible:!1,showCloseButton:!1,contentTemplate:function(n){var i=$("<div/>"),o=$("<div/>").dxLoadPanel({visible:!1}),t=o.dxLoadPanel("instance"),s=$("<div/>"),h=$("<div />").addClass("popup-buttons-container dictionary-item-form-buttons").hide();h.append($("<div />").addClass("popup-button").dxButton({stylingMode:"contained",text:dictionaryStrings.customEditFormSaveText,type:"success",width:125,onClick:function(){var n=$(".dictionary-item-form").first(),f=n.find("input[name='doUpdate']");f.length===0&&$("<input type='hidden' value='false' name='doUpdate'>").appendTo(n);n.parsley().whenValidate().then(function(){t.option("message",dictionaryStrings.customEditFormSavingText);t.show();i.dxScrollView("instance").scrollTo(o);ajaxFormSubmit(n[0],function(n){var t=JSON.parse(n);r.hide();u.remove();e.resolve(t)},function(n){console.error(n);Ext.Msg.alert("Ошибка",n.responseText)},function(){t.hide()})})}}),$("<div />").addClass("popup-button").dxButton({stylingMode:"contained",text:dictionaryStrings.customEditFormCancelText,type:"normal",width:100,onClick:function(){e.reject();r.hide();u.remove()}}));i.append($("<div />"),s,o,h);n.append(i);i.dxScrollView({height:"100%",width:"100%"});t.option("message",dictionaryStrings.customEditFormLoadingText);t.show();console.log(f);s.load(f,function(n){t.hide();var i=$(n);i.find(".application-errors").length>0||i.find("input[name='login']").length>0?(s.hide(),window.location=f):(h.show(),enableToolTips(),updateDatepickers(),fillDictDisplayValues(),bindDictionaryDisplayField(),addParsleyValidation(".dictionary-item-form"))})}}).dxPopup("instance");o=$("body").css("overflow");r.on("showing",function(){$("body").css("overflow","hidden")});r.on("hiding",function(){$("body").css("overflow",o)});return r.show(),e.promise()}return{build:t}}();(function(){function r(){var i=$("#dictionary-breadcrumb"),n;i.empty();n=t.getBreadcrumpsItems();$.each(n,function(r,u){var e=r===n.length-1,f=null;e?f=$("<li/>").addClass("breadcrumb-item active").text(u.name):(f=$("<li/>").addClass("breadcrumb-item"),$("<a href='javascript:' />").text(u.name).on("click",function(){t.setState(u.state)}).appendTo(f));i.append(f)})}function f(){DevExpress.localization.locale("ru");var t=$("#dictionary-grid");n=t.dxDataGrid({editing:{texts:{confirmDeleteMessage:""}},scrolling:{columnRenderingMode:"virtual"},noDataText:dictionaryStrings.noDataText}).dxDataGrid("instance");u().then(function(){r()})}function u(){var n=t.getState();return n.d?o():e()}function e(){var r=jQuery.Deferred(),u=dictApi.callApi(getRelativeUrl("/Administration/GetDictionaryList"));return n.refresh(),u.then(function(u){var f,e;n.option("columns",[{caption:dictionaryStrings.dictionaryColumnName,dataField:"name"}]);f=n.option("editing");f.allowAdding=!1;n.option("editing",f);e=n.option("filterRow");e.visible=!0;n.option("filterRow",e);n.option("onToolbarPreparing",null);n.option("dataSource",jQuery.map(u,function(n){return{name:n}}));i(!0);n.option("onRowClick",function(n){var i=t.getState();i.d=n.data.name;t.setState(i)});r.resolve()},function(n){r.reject(n)}),r.promise()}function o(){var u=jQuery.Deferred(),r=t.getState(),f=getRelativeUrl("/Administration/GetDictionaryDetails");return f+=t.toQueryString(r),n.refresh(),dictApi.callApi(f).then(function(f){var o=jQuery.map(f.attributes,function(n){return n.name==="code"?{caption:r.d,dataField:"code",validationRules:[{type:"required"}],allowSorting:!1,allowFiltering:!0,visible:n.visible}:{caption:n.name,dataField:n.name,allowSorting:!1,allowFiltering:!0,visible:n.visible,minWidth:10}}),e;i(!0);f.subDictionaries.length===0?(i(!1),n.option("onRowClick",function(){})):f.subDictionaries.length===1?n.option("onRowClick",function(n){r.p.push({key:n.data.key,code:n.data.code});r.s.push(f.subDictionaries[0]);t.setState(r)}):n.option("onRowClick",function(n){s(f.subDictionaries).then(function(i){r.p.push({key:n.data.key,code:n.data.code});r.s.push(i);t.setState(r)},function(){})});n.option("columns",o);n.option("remoteOperations",!0);n.option("paging",{enabled:!0,pageIndex:0,pageSize:20});e=n.option("filterRow");e.visible=!0;n.option("filterRow",e);actionBuilder.build(n,f,t);n.option("dataSource",dataSourceFactory.createDictionaryStore(t));u.resolve()},function(n){u.reject(n)}),u.promise()}function i(t){t?(n.option("hoverStateEnabled",!0),n.$element().addClass("grid-clickable")):(n.option("hoverStateEnabled",!1),n.$element().removeClass("grid-clickable"))}function s(n){var i=jQuery.Deferred(),r=$("<div>"),t;return $("body").append(r),t=r.dxPopup({width:300,height:"auto",title:dictionaryStrings.subdictionariesSelectDialogTitle,position:"center",resizeEnabled:!1,visible:!1,showCloseButton:!1,contentTemplate:function(r){var u=$("<div/>").dxRadioGroup({items:n,value:n[0]}),e=u.dxRadioGroup("instance"),f=$("<div />").addClass("popup-buttons-container");f.append($("<div />").addClass("popup-button").dxButton({stylingMode:"contained",text:dictionaryStrings.subdictionariesSelectDialogOk,type:"success",width:100,onClick:function(){i.resolve(e.option("value"));t.hide()}}),$("<div />").addClass("popup-button").dxButton({stylingMode:"contained",text:dictionaryStrings.subdictionariesSelectDialogCancel,type:"normal",width:100,onClick:function(){i.reject();t.hide()}}));r.append($("<div />"),u,f)}}).dxPopup("instance"),t.show(),i.promise()}var n=null,t=StateManager.createInstance();$(window).bind("hashchange",function(){u().then(function(){r()})});f()})();
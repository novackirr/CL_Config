(function(){function l(n){n.forEach(function(n){n.ExecNames=n.ExecDepartments.map(function(n){return n.DepartmentName}).join("<br>");n.PurchNames=n.PurchDepartments.map(function(n){return n.DepartmentName}).join("<br>")})}function y(){var n={load:function(){var n=$.Deferred();return n.resolve(h),n.promise()}};v=$("#gridContainer").dxDataGrid({dataSource:n,columnsAutoWidth:!0,showBorders:!0,filterRow:{visible:!0,applyFilter:"auto"},headerFilter:{visible:!0},columns:[{dataField:"PersonName",caption:"Сотрудник",headerFilter:{groupInterval:1e4}},{dataField:"PurchNames",caption:"Закупающие",headerFilter:{groupInterval:1e4},cellTemplate:function(n,t){n.append("<div>"+t.text+"<\/div>")}},{dataField:"ExecNames",caption:"Исполняющие",headerFilter:{groupInterval:1e4},cellTemplate:function(n,t){n.append("<div>"+t.text+"<\/div>")}},{width:100,caption:"МВП",headerFilter:{groupInterval:1e4},cellTemplate:function(n,t){var i=$("<a />");t.data.MvpInverseFlag&&t.data.Mvps&&t.data.Mvps.length>0&&i.append("<div>Инверсия:<\/div>");t.data.Mvps&&t.data.Mvps.forEach(function(n){n&&i.append("<div>"+n+"<\/div>")});i.children().size()===0&&i.append("<div>не задано<\/div>");i.addClass("dx-link").on("dxclick",function(){p(t.data)}).appendTo(n)}},{width:200,alignment:"left",caption:"Подразделения",cellTemplate:function(n,t){t.data.IsReadonlyPurch?$("<a/>").addClass("dx-link").text("Редакт. исполняющие").on("dxclick",function(){a(t.data,!1)}).appendTo(n):$("<a/>").addClass("dx-link").text("Редакт. закупающие").on("dxclick",function(){a(t.data,!0)}).appendTo(n)}},{caption:"Уведомления группы",headerFilter:{groupInterval:1e4},cellTemplate:function(n,t){var i=$("<a />");t.data.IsPersonNoticeOff?i.append("<div>Уведомления отключены<\/div>"):i.append("<div>Уведомления включены, согласно настройке<\/div>");i.addClass("dx-link").on("dxclick",function(){w(t.data)}).appendTo(n)}}]})}function p(t){var r={width:750,height:"auto",showTitle:!0,title:"МВП",visible:!1,dragEnabled:!1,closeOnOutsideClick:!0,contentTemplate:function(){var t=$("<div />"),c=$("<div/>").appendTo(t),o,h;c.dxCheckBox({value:e,text:"Инверсия условия МВП",onValueChanged:function(n){e=n.value}}).dxCheckBox("instance");var l=$("<div />").appendTo(t),f=$("<div />").appendTo(t),a=$('<div id="scrollview-content" style="max-height: 300px; "/>').appendTo(f),r=$("<div/>").appendTo(a);return r.dxList({dataSource:i,height:"100%",itemTemplate:function(n){var t=$("<div>");return $("<span>").text(n).appendTo(t),$("<span class='dx-button-content' style='float: right'><i class='dx-icon dx-icon-close'><\/i><\/span>").appendTo(t).click(function(){var t=i.indexOf(n);t>-1&&i.splice(t,1);r.dxList("instance").reload()}),t}}).dxList("instance"),f.dxScrollView({scrollByContent:!0,scrollByThumb:!0,showScrollbar:"always",reachBottomText:"Updating..."}).dxScrollView("instance"),l.dxSelectBox({dataSource:{load:function(n){var t=$.Deferred();return $.ajax({url:getAbsoluteUrl("Administration/SearchMvps"),type:"GET",cache:!1,data:{filterText:n.searchValue},success:function(n){t.resolve(n)},error:function(n,t,i){showAlert("Ошибка полуечния групп доступа",i)}}),t.promise()}},searchEnabled:!0,minSearchLength:0,onValueChanged:function(n){if(n.value){var t=i.find(function(t){return t===n.value});t||(i.push(n.value),r.dxList("instance").reload())}},onChange:function(){}}).dxSelectBox("instance"),o=$("<div style='margin:5px;'/>").appendTo(t),o.dxButton({text:"Сохранить",onClick:function(){$.ajax({url:getAbsoluteUrl("Administration/SetMpv"),type:"POST",data:{personKey:n.PersonId,accessGroupId:s,inverseMvpFlag:e?1:0,isReadonlyPurch:n.IsReadonlyPurch,isReadonlyDepId:n.IsReadonlyDepId,mvps:i},traditional:!0,success:function(){n.Mvps=i.slice();n.MvpInverseFlag=e;$("#gridContainer").dxDataGrid("instance").refresh()},error:function(n,t,i){showAlert("Ошибка при установке подразделений",i)}});u.hide()}}).dxButton("instance"),h=$("<div style='margin:5px;'/>").appendTo(t),h.dxButton({text:"Отмена",onClick:function(){u.hide()}}).dxButton("instance"),t}};u?u.option("contentTemplate",r.contentTemplate.bind(this)):u=$("#mvpEditPopup").dxPopup(r).dxPopup("instance");n=t;i=t.Mvps.slice();e=t.MvpInverseFlag;u.show()}function a(i,u){var f={width:750,height:"auto",contentTemplate:function(){var i=$("<div />"),v=$("<div />").appendTo(i),e=$("<div />").appendTo(i),y=$('<div id="scrollview-content" style="max-height: 300px; "/>').appendTo(e),f=$("<div/>").appendTo(y),o,a;return f.dxList({dataSource:t,height:"100%",itemTemplate:function(n){var i=$("<div>");return $("<span>").text(n.DepartmentName).appendTo(i),$("<span class='dx-button-content' style='float: right'><i class='dx-icon dx-icon-close'><\/i><\/span>").appendTo(i).click(function(){var i=t.indexOf(n);i>-1&&t.splice(i,1);f.dxList("instance").reload()}),i}}).dxList("instance"),e.dxScrollView({scrollByContent:!0,scrollByThumb:!0,showScrollbar:"always",reachBottomText:"Updating..."}).dxScrollView("instance"),v.dxSelectBox({dataSource:{load:function(t){var i=$.Deferred();return $.ajax({url:getAbsoluteUrl("Administration/SearchDepartments"),type:"GET",cache:!1,data:{filterText:t.searchValue,isPurch:u,personId:n.PersonId},success:function(n){i.resolve(n)},error:function(n,t,i){showAlert("Ошибка полуечния групп доступа",i)}}),i.promise()}},displayExpr:"Name",searchEnabled:!0,minSearchLength:0,onValueChanged:function(n){if(n.value){var i=t.find(function(t){return t.DepartmentDocId==n.value.Key});i||(t.push({DepartmentDocId:n.value.Key,DepartmentName:n.value.Name}),f.dxList("instance").reload())}},onChange:function(){}}).dxSelectBox("instance"),o=$("<div style='margin:5px;'/>").appendTo(i),o.dxButton({text:"Сохранить",onClick:function(){var i=n.IsReadonlyDepId,u=c?"Administration/SetPurchDepartments":"Administration/SetExecDepartments";$.ajax({url:getAbsoluteUrl(u),type:"POST",data:{personKey:n.PersonId,departmentsIds:t.map(function(n){return n.DepartmentDocId}),readonlyDep:i,accessGroupId:s},traditional:!0,success:function(){c?n.PurchDepartments=t:n.ExecDepartments=t;l(h);$("#gridContainer").dxDataGrid("instance").refresh()},error:function(n,t,i){showAlert("Ошибка при установке подразделений",i)}});r.hide()}}).dxButton("instance"),a=$("<div style='margin:5px;'/>").appendTo(i),a.dxButton({text:"Отмена",onClick:function(){r.hide()}}).dxButton("instance"),i},showTitle:!0,title:"Подразделения",visible:!1,dragEnabled:!1,closeOnOutsideClick:!0};r?r.option("contentTemplate",f.contentTemplate.bind(this)):r=$("#editPopup").dxPopup(f).dxPopup("instance");n=i;c=u;t=u?i.PurchDepartments.slice(0):i.ExecDepartments.slice(0);r.show()}function w(t){var i={width:750,height:"auto",showTitle:!0,title:"Фильтр адресатов",visible:!1,dragEnabled:!1,closeOnOutsideClick:!0,contentTemplate:function(){var t=$("<div />"),u=$("<div/>").appendTo(t),i,r;return u.dxCheckBox({value:o,text:"Отключить уведомления группы для данного пользователя",onValueChanged:function(n){o=n.value}}).dxCheckBox("instance"),$("<br><br>").appendTo(t),i=$("<div style='margin:5px;'/>").appendTo(t),i.dxButton({text:"Сохранить",onClick:function(){$.ajax({url:getAbsoluteUrl("Administration/SetPersonNoticeOffFlag"),type:"POST",data:{personKey:n.PersonId,accessGroupId:s,isReadonlyPurch:n.IsReadonlyPurch,isReadonlyDepId:n.IsReadonlyDepId,personIsNoticeOff:o?1:0},traditional:!0,success:function(){n.IsPersonNoticeOff=o;$("#gridContainer").dxDataGrid("instance").refresh()},error:function(n,t,i){showAlert("Ошибка при установке подразделений",i)}});f.hide()}}).dxButton("instance"),r=$("<div style='margin:5px;'/>").appendTo(t),r.dxButton({text:"Отмена",onClick:function(){f.hide()}}).dxButton("instance"),t}};f?f.option("contentTemplate",i.contentTemplate.bind(this)):f=$("#personNoticeFlagEditPopup").dxPopup(i).dxPopup("instance");n=t;o=t.IsPersonNoticeOff;f.show()}var h,r,u,f,v,n,c,t,i,s,e,o,b=$("#searchBox").dxSelectBox({dataSource:{load:function(n){var t=$.Deferred();return $.ajax({url:getAbsoluteUrl("Administration/GetAllAccessGroupsToFilter"),type:"GET",cache:!1,data:{filterText:n.searchValue},success:function(n){t.resolve(n)},error:function(n,t,i){showAlert("Ошибка полуечния групп доступа",i)}}),t.promise()}},displayExpr:"name",searchEnabled:!0,minSearchLength:3,onValueChanged:function(n){s=n.value.key;$.ajax({url:getAbsoluteUrl("Administration/GetPersonsByAccessGroup"),type:"GET",cache:!1,data:{accessGroupId:n.value.key},success:function(n){l(n);h=n;$("#gridContainer").dxDataGrid("instance").refresh()},error:function(n,t,i){showAlert("Ошибка полученя таблицы сотрудников",i)}})},onChange:function(){}}).dxSelectBox("instance");y()})();
(function(){})(window.ct=window.ct||{}),function(n){function t(n){this._baseUrl=n[n.length-1]==="/"?n:n+"/"}n.AddressBookApiService=t;t.prototype=Object.create(ct.api.ApiService.prototype);t.prototype.constructor=t;t.prototype.getItems=function(n){var t=this._baseUrl+"GetItems";return this.post(t,n,function(){},"json").then(function(n){return n.response})};t.prototype.getItemProperties=function(n){var t=this._baseUrl+"GetItemProperties2";return this.post(t,n).then(function(n){return n.response.data})};t.prototype.setItemProperties=function(n){var t=this._baseUrl+"SetItemProperties";return this.post(t,n).then(function(n){return n.response.data})};t.prototype.removeItemProperties=function(n){var t=this._baseUrl+"RemoveItemProperties";return this.post(t,n).then(function(n){return n.response.data})};t.create=function(n){return new t(n)}}((window.ct=window.ct||{},window.ct.api=window.ct.api||{})),function(){}(window.ct=window.ct||{}),function(){function y(){function it(n,t){var i={width:750,height:"auto",contentTemplate:function(){var n=$("<div />"),o=$("<div />").appendTo(n),u=$("<div />").appendTo(n),s=$('<div id="scrollview-content" style="max-height: 300px; "/>').appendTo(u),i=$("<div/>").appendTo(s),f,e;return y=t.value.slice(0),i.dxList({dataSource:y,height:"100%",itemTemplate:function(n){var t=$("<div>");return $("<span>").text(n.departmentName).appendTo(t),$("<span class='dx-button-content' style='float: right'><i class='dx-icon dx-icon-close'><\/i><\/span>").appendTo(t).click(function(){var t=y.indexOf(n);t>-1&&y.splice(t,1);i.dxList("instance").reload()}),t}}).dxList("instance"),u.dxScrollView({scrollByContent:!0,scrollByThumb:!0,showScrollbar:"always",reachBottomText:"Updating..."}).dxScrollView("instance"),o.dxSelectBox({dataSource:{load:function(n){var i=$.Deferred();return $.ajax({url:getAbsoluteUrl("Administration/SearchDepartments"),type:"GET",cache:!1,data:{filterText:n.searchValue,isPurch:!0,personId:t.key},success:function(n){i.resolve(n)},error:function(n,t,i){showAlert("Ошибка полуечния групп доступа",i)}}),i.promise()}},displayExpr:"Name",searchEnabled:!0,minSearchLength:0,onValueChanged:function(n){if(n.value){var t=y.find(function(t){return t.departmentDocId==n.value.Key});t||(y.push({departmentDocId:n.value.Key,departmentName:n.value.Name}),i.dxList("instance").reload())}},onChange:function(){}}).dxSelectBox("instance"),f=$("<div style='margin:5px;'/>").appendTo(n),f.dxButton({text:"Сохранить",onClick:function(){t.setValue(y);r.hide()}}).dxButton("instance"),e=$("<div style='margin:5px;'/>").appendTo(n),e.dxButton({text:"Отмена",onClick:function(){r.hide()}}).dxButton("instance"),n},showTitle:!0,title:"Подразделения",visible:!1,dragEnabled:!1,closeOnOutsideClick:!0},u=$("<div/>").appendTo(n);r=u.dxPopup(i).dxPopup("instance");r.show()}function rt(){return function(n,t){var i=t.value.map(function(n){return n.departmentName+" ("+n.pfmCode+")"}).join("<br>");n.html(i)}}function ut(){return function(n,t){var i=$("<div style='margin:5px;'/>").appendTo(n);i.dxButton({text:"Установить закупающие...",onClick:function(){it(n,t)}}).dxButton("instance")}}function ft(){return function(n,t){n.purchDepartments=t}}function b(n){return function(t,i){var u=c(n,i.value),r=p(n,u);t.text(r||" ").attr("title",r)}}function k(n,t){return function(i,r){var u=et(n,t,r);i.append(u.getContainerElement())}}function tt(n){return function(t,i,r){var u=r.properties.filter(function(t){return!t.key.startsWith(n)}).concat(i);t.properties=u}}function et(n,t,i){var r=c(n,i.value);return new g({items:r,getUpdatedItems:function(t){return d(t.$updateItemsButton,t.items.map(function(n){return n.value})).then(function(r){return r.length?r.map(function(r,f){return u(n,r.data.code,i.data.key,t.items,f)}):[]})},updateItemsButtonConfig:ot(t),onItemsUpdated:function(n){i.setValue(n)}})}function ot(n){function t(n){switch(n){case i.NOMENCLATURE:return'&dictFieldsInfo={"DictionaryFieldInfoList":[{"EditName":"groupCode","DictColumnName":"code","ShowAsDisplayText":true,"DictColumnWidth":"","ShowAsDictionaryColumn":true},{"EditName":"groupName","DictColumnName":"Наименование","ShowAsDisplayText":true,"DictColumnWidth":"","ShowAsDictionaryColumn":true},{"EditName":"registerOKPD","DictColumnName":"ОКПД2","ShowAsDisplayText":true,"DictColumnWidth":"","ShowAsDictionaryColumn":false},{"EditName":"registerOKPDName","DictColumnName":"ОКПД2 наименование","ShowAsDisplayText":true,"DictColumnWidth":"","ShowAsDictionaryColumn":false},{"EditName":"registerOKVED","DictColumnName":"ОКВЭД2","ShowAsDisplayText":true,"DictColumnWidth":"","ShowAsDictionaryColumn":false},{"EditName":"registerOKVEDName","DictColumnName":"ОКВЭД2 наименование","ShowAsDisplayText":true,"DictColumnWidth":"","ShowAsDictionaryColumn":false},{"EditName":"SMP","DictColumnName":"Признак СМП","ShowAsDisplayText":true,"DictColumnWidth":"","ShowAsDictionaryColumn":false},{"EditName":"notSMP","DictColumnName":"Исключение из СМП","ShowAsDisplayText":true,"DictColumnWidth":"","ShowAsDictionaryColumn":true},{"EditName":"PriznakSMPNametable","DictColumnName":"Причина исключения из СМП наименование","ShowAsDisplayText":true,"DictColumnWidth":"","ShowAsDictionaryColumn":false},{"EditName":"PriznakSMPtable","DictColumnName":"Причина исключения из СМП","ShowAsDisplayText":true,"DictColumnWidth":"","ShowAsDictionaryColumn":false}]}';case i.OKATO:return'&dictFieldsInfo={"DictionaryFieldInfoList":[{"EditName":"registerOKATO","DictColumnName":"code","ShowAsDisplayText":true,"DictColumnWidth":"","ShowAsDictionaryColumn":true},{"EditName":"registerOKATOName","DictColumnName":"Наименование","ShowAsDisplayText":true,"DictColumnWidth":"70","ShowAsDictionaryColumn":true}]}';default:return""}}return{attributes:[{name:"data-url",value:w.replace("AddressBook","Dictionary")+"/GetJson?dictionaryName="+n+"&showCodeColumn=True"},{name:"data-fields",value:t(n)},{name:"data-is-virtual-grid",value:"False"},{name:"data-vg-page-size",value:"200"},{name:"data-dict-name",value:n},{name:"data-multiple",value:"true"}]}}function st(){function t(){return{key:"",value:""}}return function(i,r){var f=r.value?r.value.find(function(t){return t.key===n.SUM_SIGN})||t():t(),e=r.value?r.value.find(function(t){return t.key===n.SUM})||t():t(),u=(f.value+" "+e.value).trim();i.text(u||" ").attr("title",u)}}function ht(){function t(n,t,i){var r=t?t.find(function(t){return t.key===n}):null;return r||(r=u(n,null,i)),r}return function(i,r){var f=t(n.SUM_SIGN,r.value,r.data.key),e=t(n.SUM,r.value,r.data.key),o=new nt({sign:f.value,rightValue:e.value,signDataSource:v,onUpdate:function(t){var e=u(n.SUM_SIGN,t.sign,r.data.key),i=u(n.SUM,t.rightValue,r.data.key),f=r.value.filter(function(t){return t.key!==n.SUM_SIGN&&t.key!==n.SUM});i.value!==null&&i.value!==undefined&&(f.push(e),f.push(i));r.setValue(f)}});i.append(o.getContainerElement())}}var w=$(f.containerSelector).attr("data-base-url"),y;t=ct.api.AddressBookApiService.create(w);l=$(f.containerSelector).dxResponsiveBox({rows:[{ratio:1}],cols:[{ratio:1}]});s=new DevExpress.data.CustomStore({key:"key",load:function(i){var r={data:{type:o.PERSON,selectable:{from:{type:"name",values:["Закупщик"]},ofType:o.WORK_GROUP},propertiesFilter:{propertyKeySearchString:n.COMMON}},pageInfo:{page:i.skip/i.take+1,size:i.take}};return t.getItems(r).then(function(n){return e=n.data,n.data})},insert:function(){console.log("-- INSERT")},update:function(n,i){function r(n){if(n&&n.length)return t.setItemProperties(n);var i=$.Deferred();return i.resolve(n),i}if(i.properties){var f=e.find(function(t){return t.key===n}),u=f.properties.filter(function(n){return!~i.properties.findIndex(function(t){return t.key===n.key})});return u.length?t.removeItemProperties(u).then(function(){r(i.properties)}):r(i.properties)}i.purchDepartments&&$.ajax({url:getAbsoluteUrl("AddressBook/SetUserNomenPurchDepFilter"),type:"POST","async":!1,data:{personKey:n,departmentsIds:i.purchDepartments.map(function(n){return n.departmentDocId})},traditional:!0,success:function(){},error:function(n,t,i){showAlert("Ошибка при установке подразделений",i)}})},remove:function(){console.log("-- REMOVE")}});h=new DevExpress.data.DataSource({store:s,pageSize:3});a=$(f.dataGridSelector).dxDataGrid({columns:[{caption:"Ф.И.О.",dataField:"name",allowEditing:!1},{caption:"Сумма",dataField:"properties",cellTemplate:st(),editCellTemplate:ht()},{caption:"Номенклатура",dataField:"properties",cellTemplate:b(n.NOMENCLATURE),editCellTemplate:k(n.NOMENCLATURE,i.NOMENCLATURE),setCellValue:tt(n.NOMENCLATURE)},{caption:"ОКАТО",dataField:"properties",cellTemplate:b(n.OKATO),editCellTemplate:k(n.OKATO,i.OKATO),setCellValue:tt(n.OKATO)},{caption:"Закупающее подразделение",dataField:"purchDepartments",cellTemplate:rt(),editCellTemplate:ut(),setCellValue:ft()}],dataSource:h,editing:{mode:"form",allowUpdating:!0,texts:{editRow:"Редактировать",saveRowChanges:"Сохранить",cancelRowChanges:"Отмена"}},remoteOperations:{paging:!0},scrolling:{mode:"infinite",rowRenderingMode:"virtual"},paging:{pageSize:200},selection:{mode:"single"},repaintChangesOnly:!0})}function p(n,t){return(t||[]).map(function(n){return n.value}).join(", ")}function w(n,t){return n+(t||t===0?"_"+t:"")}function b(n,t){if(!t)return 0;var r=t.map(function(n){var t=n.key.split("_");return t.pop()}),i=Math.max.apply(null,r);return i>0?i:0}function k(n,t,i){if(!t)return n;if(!i&&i!==0){var r=b(n,t);i=r+1}return w(n,i)}function u(n,t,i,r,u){r&&(r=r.filter(function(t){return t.key.startsWith(n)}));return{key:k(n,r,u),value:t,addressBookItemKey:i}}function c(n,t){return(t||[]).filter(function(t){return t.key.startsWith(n)})}function d(n,t){return HierarDictionary(n,null,{selectedNodes:t})}function g(n){function l(){s=b(i);h=new DevExpress.data.DataSource({store:s});e=k(h);o=e.dxList("instance");t.addItemButtonConfig&&(u=p(),r.append(u));t.updateItemsButtonConfig&&(f=w(),r.append(f));r.append(e)}function a(){if(!t.getAddingItems)throw new Error("_config.getAddingItem() must be defined.");t.getAddingItems(c()).then(function(n){if(i=i.concat(n),o.reload(),t.onItemsAdded)t.onItemsAdded(n);if(t.onItemsUpdated)t.onItemsUpdated(i)})}function v(){if(!t.getUpdatedItems)throw new Error("_config.getUpdatedItems() must be defined.");t.getUpdatedItems(c()).then(function(n){if(i=n,o.reload(),t.onItemsUpdated)t.onItemsUpdated(i)})}function y(n){if(t.onItemDeleted)t.onItemDeleted(n.itemData);if(t.onItemsUpdated)t.onItemsUpdated(i)}function c(){return{$addItemButton:u,$updateItemsButton:f,items:i}}function p(){var n=$("<div>");return t.addItemButtonConfig&&t.addItemButtonConfig.attributes&&t.addItemButtonConfig.attributes.forEach(function(t){n.attr(t.name,t.value)}),n.dxButton({icon:"plus",hint:"Добавить",disabled:!1,onClick:a})}function w(){var n=$("<div>");return t.updateItemsButtonConfig&&t.updateItemsButtonConfig.attributes&&t.updateItemsButtonConfig.attributes.forEach(function(t){n.attr(t.name,t.value)}),n.dxButton({icon:"edit",hint:"Изменить",disabled:!1,onClick:v})}function b(){return new DevExpress.data.CustomStore({key:"key",load:function(n){var t=n.skip,r=Math.min(i.length,n.skip+n.take);return i.slice(t,r)},insert:function(n){return i.push(n),n},update:function(n,t){var r=i.find(function(t){return t.key===n});return r&&(r.value=t.value),t},remove:function(n){i=i.filter(function(t){return t.key!==n})}})}function k(n){return $("<div>").dxList({height:t.height,dataSource:n,itemTemplate:function(n,t,i){i.append($("<div>").text(n.value))},disabled:!1,allowItemDeleting:!0,pageLoadingText:"Загрузка...",itemDeleteMode:"static",onItemDeleted:y})}var t=Object.assign({height:undefined,items:[],getAddingItems:undefined,getUpdatedItems:undefined,addItemButtonConfig:undefined,updateItemsButtonConfig:undefined,onItemsAdded:undefined,onItemsUpdated:undefined,onItemDeleted:undefined},n),r=$("<div>"),u=$("<div>"),f=$("<div>"),e=$("<div>"),o,i=t.items||[],s,h;this.getContainerElement=function(){return r};this.getItems=function(){return i};l()}function nt(n){function h(){e=c();i=l();o=i.dxValidator("instance");f=$("<div>").dxBox({direction:"row",items:[{baseSize:40,ratio:1,template:function(){return e}},{ratio:4,template:function(){return i}},]})}function c(){return $("<div>").dxDropDownBox({dataSource:t.signDataSource,value:r,contentTemplate:function(n){return $("<div>").dxList({dataSource:n.component.option("dataSource"),selectionMode:"single",onSelectionChanged:function(t){n.component.option("value",t.addedItems[0]);n.component.close()}})},onValueChanged:a})}function l(){return $("<div>").dxNumberBox({min:0,value:u,showClearButton:!0,onValueChanged:v}).dxValidator({validationRules:[{type:"pattern",pattern:/^\d*$/,message:" Значение должно быть целым числом."}]})}function a(n){r=n.value;s()}function v(n){u=n.value;s()}function s(){if(t.onUpdate){var n=o.validate();if(n.isValid)t.onUpdate({sign:r,rightValue:u})}}var t=Object.assign({sign:undefined,rightValue:undefined,signDataSource:undefined,onUpdate:undefined},n),f=$("<div>"),e=$("<div>"),i=$("<div>"),o,r=t.sign||(t.signDataSource?t.signDataSource[0]:null),u=t.rightValue;this.getContainerElement=function(){return f};h()}var f={containerId:"address-book-container",dataGridId:"address-book-datagrid",treeListId:"address-book-treelist",addPropertyButtonId:"address-book-item-add-property-button",itemPropertiesListId:"address-book-item-properties",containerSelector:"#address-book-container",treeListSelector:"#address-book-treelist",dataGridSelector:"#address-book-datagrid"},o={PERSON:"Person",WORK_GROUP:"WorkGroup"},l,a,t,n={COMMON:"vtb",NOMENCLATURE:"vtb_nomen",OKATO:"vtb_okato",SUM_SIGN:"vtb_sum_sign",SUM:"vtb_sum"},i={NOMENCLATURE:"Номенклатурные группы и позиции",OKATO:"ОКАТО"},v=["<=",">="],s,h,e,r;y();e=[]}((window.ct=window.ct||{},window.ct.utils=window.ct.utils||{}));
(function(){function o(t,i){if(typeof console!="undefined"&&t<=n.current_log_level){t==n.LOG_LEVEL_DEBUG&&console.log("DEBUG: %s",i);t==n.LOG_LEVEL_INFO&&console.info("INFO: %s",i);t==n.LOG_LEVEL_ERROR&&console.error("ERROR: %s",i);return}}function tt(t){if(!(t==n.LOG_LEVEL_DEBUG||t==n.LOG_LEVEL_INFO||t==n.LOG_LEVEL_ERROR)){o(n.LOG_LEVEL_ERROR,"cadesplugin_api.js: Incorrect log_level: "+t);return}n.current_log_level=t;n.current_log_level==n.LOG_LEVEL_DEBUG&&o(n.LOG_LEVEL_INFO,"cadesplugin_api.js: log_level = DEBUG");n.current_log_level==n.LOG_LEVEL_INFO&&o(n.LOG_LEVEL_INFO,"cadesplugin_api.js: log_level = INFO");n.current_log_level==n.LOG_LEVEL_ERROR&&o(n.LOG_LEVEL_INFO,"cadesplugin_api.js: log_level = ERROR");i()&&(n.current_log_level==n.LOG_LEVEL_DEBUG&&window.postMessage("set_log_level=debug","*"),n.current_log_level==n.LOG_LEVEL_INFO&&window.postMessage("set_log_level=info","*"),n.current_log_level==n.LOG_LEVEL_ERROR&&window.postMessage("set_log_level=error","*"))}function it(){n.CAPICOM_LOCAL_MACHINE_STORE=1;n.CAPICOM_CURRENT_USER_STORE=2;n.CADESCOM_LOCAL_MACHINE_STORE=1;n.CADESCOM_CURRENT_USER_STORE=2;n.CADESCOM_CONTAINER_STORE=100;n.CAPICOM_MY_STORE="My";n.CAPICOM_STORE_OPEN_MAXIMUM_ALLOWED=2;n.CAPICOM_CERTIFICATE_FIND_SUBJECT_NAME=1;n.CADESCOM_XML_SIGNATURE_TYPE_ENVELOPED=0;n.CADESCOM_XML_SIGNATURE_TYPE_ENVELOPING=1;n.CADESCOM_XML_SIGNATURE_TYPE_TEMPLATE=2;n.XmlDsigGost3410UrlObsolete="http://www.w3.org/2001/04/xmldsig-more#gostr34102001-gostr3411";n.XmlDsigGost3411UrlObsolete="http://www.w3.org/2001/04/xmldsig-more#gostr3411";n.XmlDsigGost3410Url="urn:ietf:params:xml:ns:cpxmlsec:algorithms:gostr34102001-gostr3411";n.XmlDsigGost3411Url="urn:ietf:params:xml:ns:cpxmlsec:algorithms:gostr3411";n.CADESCOM_CADES_DEFAULT=0;n.CADESCOM_CADES_BES=1;n.CADESCOM_CADES_T=5;n.CADESCOM_CADES_X_LONG_TYPE_1=93;n.CADESCOM_ENCODE_BASE64=0;n.CADESCOM_ENCODE_BINARY=1;n.CADESCOM_ENCODE_ANY=-1;n.CAPICOM_CERTIFICATE_INCLUDE_CHAIN_EXCEPT_ROOT=0;n.CAPICOM_CERTIFICATE_INCLUDE_WHOLE_CHAIN=1;n.CAPICOM_CERTIFICATE_INCLUDE_END_ENTITY_ONLY=2;n.CAPICOM_CERT_INFO_SUBJECT_SIMPLE_NAME=0;n.CAPICOM_CERT_INFO_ISSUER_SIMPLE_NAME=1;n.CAPICOM_CERTIFICATE_FIND_SHA1_HASH=0;n.CAPICOM_CERTIFICATE_FIND_SUBJECT_NAME=1;n.CAPICOM_CERTIFICATE_FIND_ISSUER_NAME=2;n.CAPICOM_CERTIFICATE_FIND_ROOT_NAME=3;n.CAPICOM_CERTIFICATE_FIND_TEMPLATE_NAME=4;n.CAPICOM_CERTIFICATE_FIND_EXTENSION=5;n.CAPICOM_CERTIFICATE_FIND_EXTENDED_PROPERTY=6;n.CAPICOM_CERTIFICATE_FIND_APPLICATION_POLICY=7;n.CAPICOM_CERTIFICATE_FIND_CERTIFICATE_POLICY=8;n.CAPICOM_CERTIFICATE_FIND_TIME_VALID=9;n.CAPICOM_CERTIFICATE_FIND_TIME_NOT_YET_VALID=10;n.CAPICOM_CERTIFICATE_FIND_TIME_EXPIRED=11;n.CAPICOM_CERTIFICATE_FIND_KEY_USAGE=12;n.CAPICOM_DIGITAL_SIGNATURE_KEY_USAGE=128;n.CAPICOM_PROPID_ENHKEY_USAGE=9;n.CAPICOM_OID_OTHER=0;n.CAPICOM_OID_KEY_USAGE_EXTENSION=10;n.CAPICOM_EKU_CLIENT_AUTH=2;n.CAPICOM_EKU_SMARTCARD_LOGON=5;n.CAPICOM_EKU_OTHER=0;n.CAPICOM_AUTHENTICATED_ATTRIBUTE_SIGNING_TIME=0;n.CADESCOM_AUTHENTICATED_ATTRIBUTE_DOCUMENT_NAME=1;n.CADESCOM_AUTHENTICATED_ATTRIBUTE_DOCUMENT_DESCRIPTION=2;n.CADESCOM_ATTRIBUTE_OTHER=-1;n.CADESCOM_STRING_TO_UCS2LE=0;n.CADESCOM_BASE64_TO_BINARY=1;n.CADESCOM_DISPLAY_DATA_NONE=0;n.CADESCOM_DISPLAY_DATA_CONTENT=1;n.CADESCOM_DISPLAY_DATA_ATTRIBUTE=2;n.CADESCOM_ENCRYPTION_ALGORITHM_RC2=0;n.CADESCOM_ENCRYPTION_ALGORITHM_RC4=1;n.CADESCOM_ENCRYPTION_ALGORITHM_DES=2;n.CADESCOM_ENCRYPTION_ALGORITHM_3DES=3;n.CADESCOM_ENCRYPTION_ALGORITHM_AES=4;n.CADESCOM_ENCRYPTION_ALGORITHM_GOST_28147_89=25;n.CADESCOM_HASH_ALGORITHM_SHA1=0;n.CADESCOM_HASH_ALGORITHM_MD2=1;n.CADESCOM_HASH_ALGORITHM_MD4=2;n.CADESCOM_HASH_ALGORITHM_MD5=3;n.CADESCOM_HASH_ALGORITHM_SHA_256=4;n.CADESCOM_HASH_ALGORITHM_SHA_384=5;n.CADESCOM_HASH_ALGORITHM_SHA_512=6;n.CADESCOM_HASH_ALGORITHM_CP_GOST_3411=100;n.CADESCOM_HASH_ALGORITHM_CP_GOST_3411_2012_256=101;n.CADESCOM_HASH_ALGORITHM_CP_GOST_3411_2012_512=102;n.LOG_LEVEL_DEBUG=4;n.LOG_LEVEL_INFO=2;n.LOG_LEVEL_ERROR=1}function rt(n){function t(n,t){var f;try{f=r[n](t)}catch(e){return Promise.reject(e)}return f.done?f.value:Promise.resolve(f.value).then(i,u)}var r=n(Array.prototype.slice.call(arguments,1)),i=t.bind(t,"next"),u=t.bind(t,"throw");return i()}function c(){return"Microsoft Internet Explorer"==navigator.appName||navigator.userAgent.match(/Trident\/./i)}function v(){return navigator.userAgent.match(/ipod/i)||navigator.userAgent.match(/ipad/i)||navigator.userAgent.match(/iphone/i)}function i(){var n=navigator.userAgent.match(/chrome/i),t=navigator.userAgent.match(/chromeframe/i);return(h=navigator.userAgent.match(/opr/i),nt=navigator.userAgent.match(/YaBrowser/i),n==null)?!1:n.length>0||h!=null?!0:!1}function y(n){return v()?ot("CreateObject",[n]):c()?new ActiveXObject(n):r.CreateObject(n)}function ut(n){return n<0&&(n=4294967295+n+1),n.toString(16).toUpperCase()}function p(n){var t=n.message;return t?n.number&&(t+=" (0x"+ut(n.number)+")"):t=n,t}function ft(n){if(i()||c()||v())return p(n);try{return r.getLastError()}catch(t){return p(n)}}function et(n){return r.CreateObjectAsync(n)}function ot(n,t){var i,r;if(f.call(n,t,function(n,t){r=n;var u="tmpobj="+t;eval(u);typeof i=="string"&&(i=i.replace(/\\\n/gm,"\n"),i=i.replace(/\\\r/gm,"\r"))}),r)throw r;return i}function st(){window.cadesplugin_skip_extension_install?t("Плагин недоступен"):document.addEventListener("DOMContentLoaded",function(){var n=document.createElement("div"),i;n.id="cadesplugin_ovr";n.style="visibility: hidden; position: fixed; left: 0px; top: 0px; width:100%; height:100%; background-color: rgba(0,0,0,0.7)";n.innerHTML="<div id='cadesplugin_ovr_item' style='position:relative; width:400px; margin:100px auto; background-color:#fff; border:2px solid #000; padding:10px; text-align:center; opacity: 1; z-index: 1500'><button id='cadesplugin_close_install' style='float: right; font-size: 10px; background: transparent; border: 1; margin: -5px'>X<\/button><p>Для работы КриптоПро ЭП Browser plugin на данном сайте необходимо установить расширение из каталога дополнений Opera.<p><button id='cadesplugin_install' style='font:12px Arial'>Установить расширение<\/button><\/p><\/div>";document.getElementsByTagName("Body")[0].appendChild(n);i=document.getElementById("cadesplugin_install");i.addEventListener("click",function(){opr.addons.installExtension("epebfcehmdedogndhlcacafjaacknbcm",function(){document.getElementById("cadesplugin_ovr").style.visibility="hidden";location.reload()},function(){})});document.getElementById("cadesplugin_close_install").addEventListener("click",function(){t("Плагин недоступен");document.getElementById("cadesplugin_ovr").style.visibility="hidden"});n.addEventListener("click",function(){t("Плагин недоступен");document.getElementById("cadesplugin_ovr").style.visibility="hidden"});n.style.visibility="visible";document.getElementById("cadesplugin_ovr_item").addEventListener("click",function(n){n.stopPropagation()})})}function w(){window.postMessage("cadesplugin_echo_request","*");window.addEventListener("message",function(n){n.data=="cadesplugin_loaded"&&cpcsp_chrome_nmcades.check_chrome_plugin(k,t)},!1)}function ht(){var n=document.createElement("script");n.setAttribute("type","text/javascript");n.setAttribute("src","chrome-extension://iifchhfnnmpdbibifmljnfjhpififfog/nmcades_plugin_api.js");n.onerror=t;n.onload=w;document.getElementsByTagName("head")[0].appendChild(n);n=document.createElement("script");n.setAttribute("type","text/javascript");n.setAttribute("src","chrome-extension://epebfcehmdedogndhlcacafjaacknbcm/nmcades_plugin_api.js");n.onerror=t;n.onload=w;document.getElementsByTagName("head")[0].appendChild(n)}function b(){var i=document.createElement("object"),n,t;i.setAttribute("id","cadesplugin_object");i.setAttribute("type","application/x-cades");i.setAttribute("style","visibility: hidden");document.getElementsByTagName("body")[0].appendChild(i);r=document.getElementById("cadesplugin_object");c()&&(n=document.createElement("object"),n.setAttribute("id","certEnrollClassFactory"),n.setAttribute("classid","clsid:884e2049-217d-11da-b2a4-000e7bbb2b09"),n.setAttribute("style","visibility: hidden"),document.getElementsByTagName("body")[0].appendChild(n),t=document.createElement("object"),t.setAttribute("id","webClassFactory"),t.setAttribute("classid","clsid:B04C8637-10BD-484E-B0DA-B8A039F60024"),t.setAttribute("style","visibility: hidden"),document.getElementsByTagName("body")[0].appendChild(t))}function k(){e=1;u?l():window.postMessage("cadesplugin_loaded","*")}function t(n){if(i()){if(a++,a<2)return;if(h&&(typeof n=="undefined"||typeof n=="object")){st();return}}(typeof n=="undefined"||typeof n=="object")&&(n="Плагин недоступен");e=1;u?s(n):window.postMessage("cadesplugin_load_error","*")}function d(){e!=1&&(e=1,u?s("Истекло время ожидания загрузки плагина"):window.postMessage("cadesplugin_load_error","*"))}function g(){var r,n,i;try{r=y("CAdESCOM.About");k()}catch(u){document.getElementById("cadesplugin_object").style.display="none";n=navigator.mimeTypes["application/x-cades"];n?(i=n.enabledPlugin,i?t("Плагин загружен, но не создаются обьекты"):t("Ошибка при загрузке плагина")):t("Плагин недоступен")}}function ct(){var n=document.createElement("div"),r;if(n.innerHTML="<!--[if lt IE 9]><iecheck><\/iecheck><![endif]-->",r=n.getElementsByTagName("iecheck").length==1,r){t("Internet Explorer версии 8 и ниже не поддерживается");return}i()?ht():u?window.addEventListener("load",function(){b();g()},!1):window.addEventListener("message",function(n){n.data=="cadesplugin_echo_request"&&(b(),g())},!1)}function lt(n){r=n}var f;if(!window.cadesplugin){var r,e=0,s,l,h=0,nt=0,a=0,u=!!window.Promise,n;n=u?new Promise(function(n,t){l=n;s=t}):{};f={callbacksCount:1,callbacks:{},resultForCallback:function(n,t){var i=f.callbacks[n];i&&i.apply(null,t)},call:function(n,t,i){var u=i&&typeof i=="function",e=u?f.callbacksCount++:0,r,o;u&&(f.callbacks[e]=i);r=document.createElement("IFRAME");o=["_CPNP_handle"];try{r.setAttribute("src","cpnp-js-call:"+n+":"+e+":"+encodeURIComponent(JSON.stringify(t,o)))}catch(s){alert(s)}document.documentElement.appendChild(r);r.parentNode.removeChild(r);r=null}};n.JSModuleVersion="2.0.3";n.async_spawn=rt;n.set=lt;n.set_log_level=tt;n.getLastError=ft;i()&&(n.CreateObjectAsync=et);i()||(n.CreateObject=y);window.cadesplugin_load_timeout?setTimeout(d,window.cadesplugin_load_timeout):setTimeout(d,2e4);it();n.current_log_level=n.LOG_LEVEL_ERROR;window.cadesplugin=n;ct()}})();EDS=function(){function b(){var n=navigator.userAgent.match(/chrome/i),t=navigator.userAgent.match(/chromeframe/i);return(isOpera=navigator.userAgent.match(/opr/i),isYaBrowser=navigator.userAgent.match(/YaBrowser/i),n==null)?!1:n.length>0||isOpera!=null?!0:!1}function tt(n){var t="&hashAlgorithm=";return n&&n.indexOf(t)===-1&&(n+=t+encodeURIComponent(e)),n}function a(t){var i,u,r;if(t&&t.jquery||(t=$(document)),i=t.find('[name="certificateList"]').find("input:checked").val(),i!=undefined){u=h.Item(i);r=u.PrivateKey.ProviderName;switch(r){case"Crypto-Pro GOST R 34.10-2001 Cryptographic Service Provider":e="GOST3411";o=l;break;case"Crypto-Pro GOST R 34.10-2012 Cryptographic Service Provider":e="Gost3411_2012_256";o=ht;break;case"Crypto-Pro GOST R 34.10-2012 Strong Cryptographic Service Provider":e="Gost3411_2012_512";o=ct;break;case"eToken Base Cryptographic Provider":e="Base64";break;case"Microsoft Enhanced Cryptographic Provider v1.0":case"Microsoft Base Smart Card Crypto Provider":case"Aktiv ruToken CSP v1.0":e="CADESCOM_HASH_ALGORITHM_SHA_256";break;default:console.log("Крипто провайдер указанный в сертификате не поддерживается. "+r);e="CADESCOM_HASH_ALGORITHM_SHA_256"}n=tt(n)}}function ft(n,t){var i=cadesplugin.CreateObject("CAdESCOM.HashedData");return i.Algorithm=n,i.SetHashValue(t),i}function s(n,t,i,r,u){s(n,t,i,r,u,null)}function s(s,a,v,b,k,d){var st,ut,g,at,ht,pt,ct,rt,nt,fi,kt;k&&k.jquery||(k=$("body"));st=function(){v!==undefined&&v()};ut=function(n,t){b!==undefined?b(n,t):t?k.find('[name="signInfo"]').html("<FONT color='red'>"+n+"<\/FONT>"):k.find('[name="signInfo"]').html("<FONT color='green'>"+n+"<\/FONT>")};try{if(g=cadesplugin.CreateObject("CAdESCOM.CPSigner"),at=k.find('[name="certificateList"]').find("input:checked").val(),at!=undefined){if(ht=h.Item(at),window.top.ExpectedEdsCert){var et=ht.SubjectName,ot=new t,ei=ot.GetInn(et),pi=ot.GetKpp(et),oi=ot.GetLastName(et),si=ot.GetName(et),hi=ot.GetMiddleName(et),ci=ot.GetPosition(et),vt=ot.GetEmail(et),li=ht.Thumbprint,ai=vt?vt.split("@")[0]:"",yt=register.organizations,dt=$.grep(yt,function(n){return n.Inn===ei}),gt="",ni="",ti="",ii=0;return dt.length===1&&(pt=yt.indexOf(dt[0]),ct=yt[pt],gt=ct.Inn,ni=ct.Kpp,ti=ct.Chief,ii=pt+1),k.find("#Organization option:eq("+ii+")").prop("selected",!0),k.find("#Organization").trigger("chosen:updated"),k.find("#Organization").trigger("change"),k.find("#Inn").val(gt),k.find("#Kpp").val(ni),k.find("#Chief").val(ti),k.find("#LastName").val(oi),k.find("#FirstName").val(si),k.find("#MiddleName").val(hi),k.find("#Position").val(ci),k.find("#Email").val(vt),k.find("#EdsThumbprint").val(li),k.find("#EdsThumbprintBlock").show(),k.find("#Login").val(ai),k.find("#actionDialog").modal("hide"),!1}var vi=a.SignType,ri="",ui=a.EdsAccessGroupTemplate;ui&&(ri=ui.TsaAddress);g.Certificate=ht;rt=cadesplugin.CreateObject("CAPICOM.SignedData");o?(rt=cadesplugin.CreateObject("CAdESCOM.CadesSignedData"),g.Options=1,nt=ft(o,s)):(e!="Base64"&&(rt.ContentEncoding=y),nt=cadesplugin.CreateObject("CAdESCOM.HashedData"),nt.Algorithm=l,nt.DataEncoding=y,nt.Hash(s),fi=nt.Value,rt.Content=fi);var it="",lt="",wt=!1;if(vi==1?(g.Options=1,g.TSAAddress=ri,o?(it=rt.SignHash(nt,g,p,wt),lt=bt(nt,it)):it=rt.SignCades(g,p,wt,0)):it=o?rt.SignHash(nt,g,w,wt):rt.Sign(g,!0,0),a.IsAuthentication===!0){k.find("#edsValue").val(it);st();return}kt=n.replace(i,"SignDocument");u!=undefined&&(n=u,kt=n.replace(i,"SignDocumentActivity"));r?c?f=f.map(function(n){return n.AttachmentKey===d&&(n.Sign=it,n.TimeStamp=lt),n}):(n=k.find("[data-name='documentActionUrl']").val(),n+=k.find("[name='uniqueIds']").val(),n=tt(n),k.find('[name="DigitalSignature"]').val(it),$.post(n,{DigitalSignature:it,TimeStamp:lt},function(t){var r,u,i;try{if(t=JSON.parse(t),t.status=="ERROR"){ut(t.responseMessage,!0);return}if(ut("Документ/файлы подписаны успешно",!1),st(),r=k.find('[name="isEisExport"]').is(":checked"),r)return;if(u=k.find("[name='hfApproveSettings']").length>0||k.find("[name='hfCompleteActivityPlugin']").length>0,u)return;i=n.replace("SignAttachmentHandler","AttachmentSignConfirmation");i=i.split("?")[0];i+="?documentId="+t.documentId+"&attachmentKey="+t.attachmentKey;ModalHelper({dialog:"#modalInfo",url:i,isTargetBlank:!1,beforeSubmit:undefined,useDefaultSubmit:!1}).openWindow()}catch(f){ut("Ошибка подписания",!0)}})):$.post(kt,{sign:it,TimeStamp:lt},function(n){var t=JSON.parse(n);t.status=="ERROR"&&ut(t.responseMessage,!0);t.status=="OK"&&st()})}else return ut("Выберите сертификат для создания подписи",!0),!1}catch(yi){return ut("Ошибка создания подписи. Ошибка: "+cadesplugin.getLastError(yi),!0),!1}}function vt(n,t,i,r){var u=jQuery.Deferred();return yt(n).then(function(f){var e=null,o,s;if(f.status==="ERROR")e=v(n,t,i,r,!1,function(){var n=f.responseMessage.split("\r\n");n.pop();showCommonErrors(n)});else{if(o=!0,disableCertificateValidation)o=!0;else try{o=n.IsValid().Result}catch(h){console.log(h)}o?(s=typeof n.PrivateKey!="unknown",e=s?v(n,t,i,r,!0,null):v(n,t,i,r,!1,function(){showCommonErrors("Ошибка подписи. Не найден закрытый ключ.")})):e=v(n,t,i,r,!1,function(){n.Display()})}u.resolve(e)},function(n){showCommonErrors(n);u.resolve()}),u.promise()}function yt(n){var t=jQuery.Deferred(),r=$("base").attr("href")==="/"?"":$("base").attr("href"),u=r+"/Eds/VerifySignature",i=new FormData;return i.append("publicCertificate",n.Export()),$.ajax({url:u,type:"POST",mimeType:"multipart/form-data",cache:!1,data:i,contentType:!1,cache:!1,processData:!1}).then(function(n){var i=JSON.parse(n);t.resolve(i)},function(n){console.error(n);t.reject()}),t.promise()}function t(){}function pt(n){var t=$("[data-name='documentHashUrl']").val();t=t.replace("GetDocumentHashCode","GetDocumentSign");$.post(t,function(t){st(t,n)})}function wt(n,t,i){var u=function(n){alert(n)},f=$("[name='documentHashUrl']").val(),e=f+"?documentId="+n+"&attachKey="+t+"&edsKey="+i,r=f.replace("GetAttachmentHashCodeVerify","LogVerifySign")+"?documentId="+n+"&attachKey="+t+"&isValid=";$.get(e,function(n){var t,i,o,e,f;if(n.Sign=="empty")u("Документ не имеет подписи.",!0);else{t=cadesplugin.CreateObject("CAPICOM.SignedData");try{i=cadesplugin.CreateObject("CAdESCOM.HashedData");i.Algorithm=l;i.DataEncoding=y;i.Hash(n.Data);o=i.Value;t.Content=o;t.Verify(n.Sign,!0,0);t.Signers!=undefined&&(e=t.Signers.Item(1).Certificate.SubjectName);f="Документ имеет подпись, подпись успешно верифицирована.";f+=" Документ подписал: "+s.Person;e!=undefined&&(f+=" Владелец сертификата:"+e);u(f,!1);r=r+"true";$.get(r,function(){})}catch(h){u("Ошибка проверки подписи."+h.message,!0);r=r+"false";$.get(r,function(){})}}})}function bt(n,t){var i;try{i=cadesplugin.CreateObject("CAdESCOM.CadesSignedData");i.VerifyHash(n,t,p);var r=i.Signers.Item(1),e=r.SigningTime,u=r.SignatureTimeStampTime;return new Date(u).toISOString()}catch(f){throw"Не удалось извлечь штамп времени из подписи. Ошибка: "+cadesplugin.getLastError(f);}}var h=[],w=1,y=1,p=93,l=100,ht=101,ct=102,r=$('[name="isAttachEDS"]').is(":checked"),n=$("[data-name='documentHashUrl']").val(),u=$("[data-name='activitySignature']").val(),i,d,c,f=[],o,e,g,nt,it,rt,ut,et,v,ot,st;if(b()){var k=new Date,lt="?v="+k.getDate()+""+k.getMonth()+""+k.getFullYear(),at='<script language="javascript" src="'+$("[name = 'digitalSignatureChromeUrl']").val()+lt+'"><\/script>';document.write(at)}return $(document).ready(function(){b()&&(EDS=EDS_async)}),g=function(t,e,o,h){var l,y,v;h||(h=function(){t!==undefined&&t()});u=$("[data-name='activitySignature']").val();l=function(n,t){e!==undefined?e(n,t):t?$('[name="signInfo"]').html("<FONT color='red'>"+n+"<\/FONT>"):$('[name="signInfo"]').html("<FONT color='green'>"+n+"<\/FONT>")};n=$("[data-name='documentHashUrl']").val();a();i="GetDocumentHashCode";y=n.replace(i,"GetSignType");$.ajax({url:y,type:"get","async":!1,data:{edsSend:!1},success:function(n){v=n},error:function(){}});$.ajax({url:n,type:"GET",cache:!1,"async":!1,data:{edsSend:!1},success:function(n){s(n,v,t,e)},error:function(){}});i="GetAttachmentHashes";u&&(n=$("[data-name='documentHashUrl']").val(),a(),u=undefined,$("[data-name='activitySignature']").remove());n=n.replace("GetDocumentHashCode",i);r=!0;c=!0;$.ajax({url:n,type:"get","async":!1,cache:!1,data:{edsSend:!1},success:function(u){var y,p,a;if($.each(u,function(n,i){var r={Hash:i.Hash,AttachmentKey:i.AttachmentKey};f.push(r);s(i.Hash,v,t,e)}),f.length>0)y=n.replace(i,"SignAllAttachmentHandler"),y=y.replace("ContextAction","Attachment"),$.post(y,{sign:JSON.stringify(f)},function(t){var u,i;try{if(t=JSON.parse(t),t.status=="ERROR"){l(t.responseMessage,!0);return}if(h(),u=$('[name="isEisExport"]').is(":checked"),u)return;l("Документ/файлы подписаны успешно",!1);r=!1;c=!1;i=n.replace("GetAttachmentHashes","DocumentAttachmentSignConfirmation");i=i.replace("ContextAction","Attachment");i=i.split("?")[0];i+="?documentId="+t.documentId+"&type=2";o||ModalHelper({dialog:"#modalInfo",url:i,isTargetBlank:!1,beforeSubmit:undefined,useDefaultSubmit:!1}).openWindow()}catch(f){l("Ошибка подписания",!0)}});else{if(h(),p=$('[name="isEisExport"]').is(":checked"),p)return;a=n.replace("GetAttachmentHashes","DocumentAttachmentSignConfirmation");a=a.replace("ContextAction","Attachment");a+="&type=0";o||ModalHelper({dialog:"#modalInfo",url:a,isTargetBlank:!1,beforeSubmit:undefined,useDefaultSubmit:!1}).openWindow()}},error:function(){}})},nt=function(t,e,o,h){var h,l,v;h||(h=function(){t!==undefined&&t()});u=$("[data-name='activitySignature']").val();l=function(n,t){e!==undefined?e(n,t):t?$('[name="signInfo"]').html("<FONT color='red'>"+n+"<\/FONT>"):$('[name="signInfo"]').html("<FONT color='green'>"+n+"<\/FONT>")};n=$("[data-name='documentHashUrl']").val();a();i="GetAttachmentKeys";u&&(n=$("[data-name='documentHashUrl']").val(),a(),u=undefined,$("[data-name='activitySignature']").remove());n=n.replace("GetDocumentHashCode",i);r=$('[name="isAttachEDS"]').is(":checked");u=$("[data-name='activitySignature']").val();c=$('[data-name="isSignAllAttachment"]').val();d=n.replace(i,"SignDocument");r=$('[name="isAttachEDS"]').is(":checked");v=n.replace(i,"GetSignType");d.indexOf("&attachKey=")!=-1&&(r=!0,c=!0);$.ajax({url:v,cache:!1,data:{edsSend:!1},success:function(u){$.ajax({url:n,cache:!1,success:function(a){if(a.length==0){l("У подписываемого документа отсутствует документация.",!0);return}if(n=n.replace(i,"GetAttachmentHashCode"),$.each(a,function(i,r){try{$.ajax({url:n.replace("&attachKey=","&attachKey="+r),cache:!1,"async":!1,error:function(n){l("Ошибка подписания: "+n.statusText,!0);return},success:function(n){console.info("Документ с ключом "+r+" объем:"+n.length);var i={AttachmentKey:r};f.push(i);s(n,u,t,e,null,r)}})}catch(o){l("Ошибка подписания"+o.message,!0);return}}),f.length>0&&a.length==f.length){var v=n.replace("GetAttachmentHashCode","SignAllAttachmentHandler");v=v.replace("ContextAction","Attachment");$.post(v,{sign:JSON.stringify(f)},function(t){try{if(t=JSON.parse(t),t.status=="ERROR"){l(t.responseMessage,!0);return}l("Документ/файлы подписаны успешно",!1);h();r=!1;c=!1;var i=n.replace("GetAttachmentHashes","DocumentAttachmentSignConfirmation");i=i.replace("ContextAction","Attachment");i=i.split("?")[0];i+="?documentId="+t.documentId+"&type=1";o||ModalHelper({dialog:"#modalInfo",url:i,isTargetBlank:!1,beforeSubmit:undefined,useDefaultSubmit:!1}).openWindow()}catch(u){l("Ошибка подписания",!0)}})}}})}})},it=function(t,f,e,o){o&&o.jquery||(o=$(document));n=o.find("[data-name='documentHashUrl']").val();r=o.find('[name="isAttachEDS"]').is(":checked");u=o.find("[data-name='activitySignature']").val();r?(i="GetAttachmentHashCode",n=o.find("[data-name='documentAttachHashUrl']").val()):i="GetDocumentHashCode";a(o);r=o.find('[name="isAttachEDS"]').is(":checked");var h=n.replace(i,"GetSignType");$.get(h,{edsSend:!1},function(i){$.ajax({url:n,cache:!1,success:function(r){s(r,i,function(){var r,u,i;(t(),r=o.find('[name="isEisExport"]').is(":checked"),r)||(u=o.find('[name="isContext"]').is(":checked"),u)||(i=n.replace("GetDocumentHashCode","DocumentAttachmentSignConfirmation"),i=i.replace("ContextAction","Attachment"),i+="&type=0",e||ModalHelper({dialog:"#modalInfo",url:i,isTargetBlank:!1,beforeSubmit:undefined,useDefaultSubmit:!1}).openWindow())},f,o)}})})},rt=function(n,t){dataToSign=$("#edsGuid").val();var i=$("#tspServerUrl").val();signType={SignType:i?1:0,IsAuthentication:!0,EdsAccessGroupTemplate:{TsaAddress:i}};s(dataToSign,signType,function(){n();$("#content-login-form").submit();waitingDialog.showWaiting()},t)},ut=function(n,t){var c=function(){n!==undefined&&n()},e=function(n,i){t!==undefined?t(n,i):i?$('[name="signInfo"]').html("<FONT color='red'>"+n+"<\/FONT>"):$('[name="signInfo"]').html("<FONT color='green'>"+n+"<\/FONT>")},o=$('[name="certificateList"]').find("input:checked").val(),u,f,i,r,s;if(o!=undefined){u=h.Item(o);f=u.PrivateKey.ProviderName;switch(f){case"Crypto-Pro GOST R 34.10-2001 Cryptographic Service Provider":break;default:i="Крипто провайдер указанный в сертификате не поддерживается. "+f;alert(i);throw i;}try{r=cadesplugin.CreateObject("CAdESCOM.CPSigner");r.Certificate=u;var a=$("[name='signature-hash']").val(),v=ft(l,a),y=cadesplugin.CreateObject("CAdESCOM.CadesSignedData");return r.Options=1,s=y.SignHash(v,r,w,!0),$("[name='signature']").val(s),c(),!0}catch(i){return e("Ошибка создания подписи. Ошибка: "+cadesplugin.getLastError(i),!0),!1}}else return e("Выберите сертификат для создания подписи",!0),!1},et=function(n,t){var e,u,f,i,s,o,c,r,l;for(b()||(e=$("#actionDialog").find(".modal-info-wrapper"),e.text("При подписании документации в браузере Internet Explorer, максимальный размер файла не должен превышать 20 мб, при необходимости подписания файлов больших размеров, необходимо воспользоваться браузером Google Chrome"),e.show()),u=jQuery.Deferred(),f=cadesplugin.CreateObject("CAPICOM.Store"),f.Open(),h=f.Certificates,i=$('[name="certificateList"]'),n&&n.jquery&&(i=n.find('[name="certificateList"]')),i.html(""),s="<div class='modal-loading-wrapper' style='background-color:white'><div class='loading-image loading-image-shown'>&nbsp;<\/div><\/div>",i.append(s),o=[],c=h.count,r=1;r<c+1;r++)l=h.Item(r),o.push(vt(l,r,i,t));return $.when.apply($,o).then(function(){var t,n;f.Close();i.find(".modal-loading-wrapper").remove();t=arguments;$.each(t,function(n,t){t!=null&&$(t).find("input").length>0&&i.append($(t))});n=i.find("input");n.length==1&&n.first().attr("checked","checked");u.resolve()},function(n){u.reject(n)}),u.promise()},v=function(n,i,r,u,f,e){(n.SubjectName==""||n.SubjectName==null)&&(f=!1);var o=new t,h='<span class="search-result-cell-value"><b>Владелец сертификата: <\/b>'+o.GetCertName(n.SubjectName)+"<\/span><br/>",c='<span class="search-result-cell-value"><b>Центр выдачи сертификата: <\/b>'+o.GetCertName(n.IssuerName)+"<\/span><br/>",l='<span class="search-result-cell-value"><b>Действителен с: <\/b>'+o.GetCertDate(n.ValidFromDate)+"<\/span><br/>",a='<span class="search-result-cell-value"><b>Действителен по: <\/b>'+o.GetCertDate(n.ValidToDate)+"<\/span>",v="certificatelist"+u?u:"",y=f?"<input type='radio' name='"+v+"'  value='"+i+"' />":"",p=f?"":"<span class='certificate-error-text'>Некорректный сертификат<\/span>",s=$('<li class="certificate '+(f?"":"invalid")+'">'+y+h+c+l+a+p+"<\/li>");return!f&&e&&s.click(e),s},ot=function(n){var i=$('[name="certificateList"]'),t;return n&&n.jquery&&(i=n.find('[name="certificateList"]')),t=i.find("input"),t.length>0&&t.first().attr("checked","checked"),t.length>0},t.prototype.extract=function(n,t){var u="",i=n.indexOf(t),r;return i>=0&&(r=n.indexOf(", ",i),u=r<0?n.substr(i):n.substr(i,r-i)),u},t.prototype.Print2Digit=function(n){return n<10?"0"+n:n},t.prototype.GetCertDate=function(n){var t=new Date(n);return this.Print2Digit(t.getUTCDate())+"."+this.Print2Digit(t.getMonth()+1)+"."+t.getFullYear()+" "+this.Print2Digit(t.getUTCHours())+":"+this.Print2Digit(t.getUTCMinutes())+":"+this.Print2Digit(t.getUTCSeconds())},t.prototype.GetCertDateUSLocale=function(n){var t=new Date(n);return this.Print2Digit(t.getMonth()+1)+"/"+this.Print2Digit(t.getUTCDate())+"/"+t.getFullYear()+" "+this.Print2Digit(t.getUTCHours())+":"+this.Print2Digit(t.getUTCMinutes())+":"+this.Print2Digit(t.getUTCSeconds())},t.prototype.GetCertName=function(n){return this.extract(n,"CN=").replace("CN=","")},t.prototype.GetPosition=function(n){return this.extract(n," T=").replace(" T=","")},t.prototype.GetOrganization=function(n){return this.extract(n,"O=").replace("O=","")},t.prototype.GetInn=function(n){return this.extract(n,"ИНН=").replace("ИНН=","")},t.prototype.GetKpp=function(n){var t=this.extract(n,"OID.1.2.840.113549.1.9.2=").replace("OID.1.2.840.113549.1.9.2=",""),i="KPP=";return t=t.substring(t.indexOf(i)+i.length),t.indexOf("/")!==-1&&(t=t.split("/")[0]),t},t.prototype.GetEmail=function(n){return this.extract(n,"E=").replace("E=","")},t.prototype.GetLastName=function(n){return this.extract(n,"SN=").replace("SN=","")},t.prototype.GetName=function(n){return this.extract(n,"G=").replace("G=","").split(" ")[0]},t.prototype.GetMiddleName=function(n){return this.extract(n,"G=").replace("G=","").split(" ")[1]},t.prototype.GetIssuer=function(n){return this.extract(n,"CN=").replace("CN=","")},t.prototype.GetCertInfoString=function(n,t){return this.extract(n,"CN=")+"; Выдан: "+this.GetCertDate(t)},st=function(n,t){var i=function(n,i){t!==undefined?t(n,i):i?$('[name="signInfo"]').html("<FONT color='red'>"+n+"<\/FONT>"):$('[name="signInfo"]').html("<FONT color='green'>"+n+"<\/FONT>")},r=$("[data-name='documentHashUrl']").val(),u=r.replace("GetDocumentHashCode","GetSignType");$.get(u,function(t){$.get(r,function(r){var f,s,u,o,e;if(sSignedMessage=n.Sign,sSignedMessage=="empty")i("Документ не имеет подписи.",!0);else{f=cadesplugin.CreateObject("CAdESCOM.HashedData");f.Algorithm=l;f.Hash(r);r=f.Value;s=t.SignType;u=cadesplugin.CreateObject("CAdESCOM.CadesSignedData");try{u.ContentEncoding=y;u.Content=r;s==1?u.VerifyCades(sSignedMessage,p):u.VerifyCades(sSignedMessage,w,!0);u.Signers!=undefined&&(o=u.Signers.Item(1).Certificate.SubjectName);e="Документ имеет подпись, подпись успешно верифицирована.";e+=" Документ подписал: "+n.Person;o!=undefined&&(e+=" Владелец сертификата:"+o);i(e,!1)}catch(h){i("Ошибка проверки подписи.",!0)}}})})},{SignCreate:it,SignForEis:ut,SignAuthentication:rt,SignAttachments:nt,SignDocumentWithAtachments:g,GetCertificates:et,VerifyDocumentSign:pt,VerifyAttachmentSign:wt,ClearCache:function(){f=[]},TryToSelectDefaultCertificate:ot}}(),function(n){n.capicom=n.capicom||{};n.capicom.CAPICOM_CURRENT_USER_STORE=2;n.capicom.CAPICOM_STORE_OPEN_READ_ONLY=0;n.capicom.CAPICOM_CERTIFICATE_FIND_TIME_VALID=9;n.capicom.CAPICOM_CERTIFICATE_FIND_SHA1_HASH=0;n.capicom.CAPICOM_CERT_INFO_SUBJECT_SIMPLE_NAME=0;n.capicom.CAPICOM_AUTHENTICATED_ATTRIBUTE_SIGNING_TIME=0;n.capicom.CAPICOM_ENCODE_BASE64=0;n.capicom.CAPICOM_ENCODE_BINARY=1;n.capicom.CAPICOM_VERIFY_SIGNATURE_AND_CERTIFICATE=1;n.capicom.CAPICOM_E_CANCELLED=-2138568446;n.capicom.CAPICOM_E_NOT_INSTALLED=-2146827859;n.capicom.getCertificatesList=function(){var i,r,u,t,f,e;try{for(i=new ActiveXObject("CAPICOM.Store"),i.Open(n.capicom.CAPICOM_CURRENT_USER_STORE,"My",n.capicom.CAPICOM_STORE_OPEN_READ_ONLY),r=i.Certificates,u=[],t=1;t<=r.Count;t++)f=r.Item(t),e={thumbprint:f.Thumbprint,displayName:f.GetInfo(n.capicom.CAPICOM_CERT_INFO_SUBJECT_SIMPLE_NAME)},u.push(e);return u}catch(o){return[]}};n.capicom.findCertificateByHash=function(t){var i,u,r;try{return i=new ActiveXObject("CAPICOM.Store"),i.Open(n.capicom.CAPICOM_CURRENT_USER_STORE,"My",n.capicom.CAPICOM_STORE_OPEN_READ_ONLY),u=i.Certificates.Find(n.capicom.CAPICOM_CERTIFICATE_FIND_SHA1_HASH,t),r=new ActiveXObject("CAPICOM.Signer"),r.Certificate=u.Item(1),r}catch(f){if(f.number!=CAPICOM_E_CANCELLED)return new ActiveXObject("CAPICOM.Signer")}};n.capicom.sign=function(t,i,r){var u;try{u=new ActiveXObject("CAPICOM.SignedData");u.Content=t;var e=n.capicom.findCertificateByHash(r),f=new ActiveXObject("CAPICOM.Attribute"),o=new Date;return f.Name=n.capicom.CAPICOM_AUTHENTICATED_ATTRIBUTE_SIGNING_TIME,f.Value=o.getVarDate(),o=null,e.AuthenticatedAttributes.Add(f),u.Sign(e,i,n.capicom.CAPICOM_ENCODE_BASE64)}catch(s){return!1}};n.capicom._to_hex=function(n){var t=["0","1","2","3","4","5","6","7","8","9","A","B","C","D","E","F"];return t[parseInt(n/16)]+t[parseInt(n%16)]};n.capicom._to_utf8_hex=function(t){for(var i,r="",u=0;u<t.length;u++)i=t.charCodeAt(u),i<=127?r+=n.capicom._to_hex(i):i>=128&&i<=2047?(r+=n.capicom._to_hex(i>>6&31|192),r+=n.capicom._to_hex(i&63|128)):(r+=n.capicom._to_hex(i>>12|224),r+=n.capicom._to_hex(i>>6&63|128),r+=n.capicom._to_hex(i&63|128));return r};n.capicom.verify=function(t){var r=new ActiveXObject("CAPICOM.SignedData"),u=new ActiveXObject("CAPICOM.Utilities"),f,i;try{f=r.Verify(t,!1,n.capicom.CAPICOM_VERIFY_SIGNATURE_AND_CERTIFICATE);i={rawData:u.BinaryStringToByteArray(r.Content),success:!0}}catch(e){i={error:e,success:!1}}return i}}(jQuery);
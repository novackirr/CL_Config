var dictionaryStrings=function(){return{noDataText:"Отсутствуют данные для отображения",formName:"Данные о контрагенте",rootBreadcrumbName:"Все справочники",subdictionariesSelectDialogTitle:"Подчиненные словари",customEditFormCancelText:"Отмена",customEditFormLoadingText:"Загрузка..."}}(),StateManager=function(){function n(){}return n.prototype={getState:function(){var t=window.location,n;return t.hash&&t.hash!==""?(n=t.hash.substring(1),n=decodeURIComponent(n),JSON.parse(n)):this.getInitialState()},setState:function(n){var t=window.location,i=encodeURIComponent(JSON.stringify(n));t.hash=i},getInitialState:function(){return{d:null,s:[],p:[]}},toQueryString:function(n){n||(n=this.getState());var t=$.map(n.s,function(n){return"&subDictionaryNames="+encodeURIComponent(n)});return t.length===0&&t.push("&subDictionaryNames="),"?dictionaryName="+encodeURIComponent(n.d)+t.join("")+"&parent="+(n.p.length>0?n.p[n.p.length-1].key:null)}},{createInstance:function(){return new n}}}(),dictApi=function(){function t(t){var i=r(t);return n(i),i}function i(t,i){var r=u(t,i);return n(r),r}function n(n){return waitingDialog.showWaiting(),n.always(function(){waitingDialog.hide()})}function r(n){var t=jQuery.Deferred();return $.ajax({url:n,type:"GET",contentType:!1,cache:!1,processData:!1}).then(function(n){var i=JSON.parse(n);i.status==="OK"?(i=JSON.parse(i.responseMessage),t.resolve(i)):(showCommonErrors([i.responseMessage]),t.reject(i.responseMessage))},function(n){showCommonErrors([n.responseText]);t.reject(n.responseText)}),t.promise()}function u(n,t){var i=jQuery.Deferred(),r=new FormData;return $.each(t,function(n,t){r.append(n,t)}),$.ajax({url:n,type:"POST",mimeType:"multipart/form-data",cache:!1,data:r,contentType:!1,cache:!1,processData:!1}).then(function(n){var t=JSON.parse(n);t.status==="OK"?i.resolve():(showCommonErrors([t.responseMessage]),i.reject(t.responseMessage))},function(n){showCommonErrors([n.responseText]);i.reject(n.responseText)}),i.promise()}return{callApi:t,postApi:i}}(),dataSourceFactory=function(){function n(n){var i=n.getState(),t=n.toQueryString(i),r=getRelativeUrl("/Administration/GetDictionaryItems")+t,u=getRelativeUrl("/Administration/RemoveDictionaryItem")+t,f=getRelativeUrl("/Administration/UpdateDictionaryItem")+t,e=getRelativeUrl("/Administration/AddDictionaryItem")+t;return DevExpress.data.AspNet.createStore({key:"key",loadUrl:r,deleteUrl:u,deleteMethod:"POST",updateUrl:f,updateMethod:"POST",insertUrl:e,insertMethod:"POST"})}return{createDictionaryStore:n}}(),actionBuilder=function(){function n(n){n.option("onToolbarPreparing",function(i){t(i,n)});var i=n.option("columns");n.option("columns",i)}function t(n,t){i(n,t);addDxGridToolbarStateItems(n,t);t.option("export_url",getRelativeUrl("/GridExport/ExportSuppliers?fileName=Контрагенты"));addCreateExportButton(n,t)}function i(n){n.toolbarOptions.items.unshift({location:"after",widget:"dxButton",options:{hint:"Выбор столбцов",icon:"column-chooser",onClick:function(t){u(n,t)}}})}function r(n){for(var t,r,u=[],f=[],e=n.columnCount(),i=0;i<e;i++)t=n.columnOption(i),r={visible:!0,index:t.index,caption:t.caption,dataField:t.dataField},t.visible&&f.push(r),u.push(r);return{columns:u,checked:f}}function u(n,t){var i=n.component,u=i.colChooserPopup,f;u||(u=i.colChooserPopup=$("#colChooserPopup_"+n.element[0].id).dxPopup({showCloseButton:!0,visible:!1,title:"Выбор столбцов",width:350,height:520}));var s=r(i),o=u.find(".dx-popup-content"),c=u.find("[data-item-tooltip]");if(o.is(":empty")&&!c.length){f=document.createElement("div");$(f).addClass("grid-columns-list");var l=$(f).dxList({items:s.columns,selectionMode:"all",selectedItems:s.checked,showSelectionControls:!0,itemTemplate:function(n,t,i){appendTooltip("<span>"+n.caption+"<\/span>",i);i.append("<b>"+n.caption+"<\/b>")},onSelectionChanged:function(t){var u,f,r;for(i.beginUpdate(),u=t.addedItems.length,r=0;r<u;r++)i.columnOption(t.addedItems[r].index,"visible",!0);for(f=t.removedItems.length,r=0;r<f;r++)i.columnOption(t.removedItems[r].index,"visible",!1);i.endUpdate();dxGridSortCustomChooserColumns(t.component);scaleWidthVisibleColumns(i,n.element)},onInitialized:function(n){dxGridSortCustomChooserColumns(n.component)}}).dxList("instance"),h=document.createElement("div"),e=null;$(h).dxTextBox({value:"",placeholder:"Поиск...",showClearButton:!0,valueChangeEvent:"keyup",onValueChanged:function(n){e&&(window.clearTimeout(e),e=null);e=window.setTimeout(function(){for(var r=i.colChooserList,u=r.option("items"),s=u.length,t=0;t<s;t++){var f=u[t],e=n.value.toLowerCase(),o=!0;e&&e.trim()!==""&&(o=f.caption.toLowerCase().search(n.value.toLowerCase())>=0);f.visible=o}r.repaint()},200)}});o.append(h);o.append(f);i.colChooserList=l}u.dxPopup("instance").option({showCloseButton:!0,visible:!0,position:{my:"right top",at:"left bottom",of:t.element}})}return{build:n}}();(function(){function r(){DevExpress.localization.locale("ru");var t=$("#dictionary-grid");n=t.dxDataGrid({editing:{texts:{confirmDeleteMessage:""}},scrolling:{columnRenderingMode:"virtual"},noDataText:dictionaryStrings.noDataText}).dxDataGrid("instance");i()}function i(){return u()}function u(){var r=jQuery.Deferred(),i=t.getState(),u;return i.d="Контрагенты",t.setState(i),u=getRelativeUrl("/Administration/GetDictionaryDetails?dictionaryName=Контрагенты&subDictionaryNames="),n.refresh(),dictApi.callApi(u).then(function(u){var s=jQuery.map(u.attributes,function(n){return n.name==="code"?{caption:i.d,dataField:"code",validationRules:[{type:"required"}],allowEditing:!1,allowSorting:!0,allowFiltering:!0,visible:n.visible}:{caption:n.name,dataField:n.name,allowEditing:!1,allowSorting:!0,allowFiltering:!0,visible:n.visible,minWidth:10}}),o;f(!0);n.option("onRowClick",function(t){e(n,t,i.d,u.customForm)});n.option("columns",s);n.option("remoteOperations",!0);n.option("paging",{enabled:!0,pageIndex:0,pageSize:20});o=n.option("filterRow");o.visible=!0;n.option("filterRow",o);actionBuilder.build(n);n.option("dataSource",dataSourceFactory.createDictionaryStore(t));r.resolve()},function(n){r.reject(n)}),r.promise()}function f(t){t?(n.option("hoverStateEnabled",!0),n.$element().addClass("grid-clickable")):(n.option("hoverStateEnabled",!1),n.$element().removeClass("grid-clickable"))}function e(n,t,i,r){o(i,t.data.key,r).then(function(i){n.beginUpdate();$.each(i,function(i,r){n.cellValue(t.rowIndex,i,r)});n.endUpdate()},function(){})}function o(n,t,i){var u=getRelativeUrl("/Dictionary/GetDictionaryForm")+"?name="+encodeURIComponent(n)+"&template="+encodeURIComponent(i)+"&key="+t,e=jQuery.Deferred(),f=$("<div>"),r,o;$("body").append(f);r=f.dxPopup({title:dictionaryStrings.formName,position:"center",resizeEnabled:!1,visible:!1,showCloseButton:!1,contentTemplate:function(n){var t=$("<div/>"),h=$("<div/>").dxLoadPanel({visible:!1}),i=h.dxLoadPanel("instance"),o=$("<div/>"),s=$("<div />").addClass("popup-buttons-container dictionary-item-form-buttons").hide();s.append($("<div />").addClass("popup-button").dxButton({stylingMode:"contained",text:dictionaryStrings.customEditFormCancelText,type:"normal",width:100,onClick:function(){e.reject();r.hide();f.remove()}}));t.append($("<div />"),o,h,s);n.append(t);t.dxScrollView({height:"100%",width:"100%"});i.option("message",dictionaryStrings.customEditFormLoadingText);i.show();console.log(u);o.load(u,function(n){i.hide();var t=$(n);t.find(".application-errors").length>0||t.find("input[name='login']").length>0?(o.hide(),window.location=u):(s.show(),enableToolTips(),updateDatepickers(),fillDictDisplayValues(),bindDictionaryDisplayField(),addParsleyValidation(".dictionary-item-form"))})}}).dxPopup("instance");o=$("body").css("overflow");r.on("showing",function(){$("body").css("overflow","hidden")});r.on("hiding",function(){$("body").css("overflow",o)});return r.show(),e.promise()}var n=null,t=StateManager.createInstance();$(window).bind("hashchange",function(){i()});r()})();
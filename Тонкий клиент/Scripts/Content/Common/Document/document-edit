"use strict";
; (function () { }(window.ct = window.ct || {}));

;jQuery.browser = {};
;(function () {
    jQuery.browser.msie = false;
    jQuery.browser.version = 0;
    if (navigator.userAgent.match(/MSIE ([0-9]+)\./)) {
        jQuery.browser.msie = true;
        jQuery.browser.version = RegExp.$1;
    }
})();

; (function (doc) {
    doc.edit = {};

    var localFilter = { items : [] };

    /**
     * Тип action'a, вызываемого при сохранении документа (определяет, в какой момент будет вызван action).
     */
    doc.edit.actionType = {
        BEFORE_VALIDATION: "document-edit-before-validation",
        AFTER_SUCCESSFUL_VALIDATION: "document-edit-after-successful-validation",
        AFTER_FAILED_VALIDATION: "document-edit-after-failed-validation",
        AFTER_SUCCESSFUL_SAVE: "document-edit-after-successful-save",
        AFTER_FAILED_SAVE: "document-edit-after-failed-save",
        BEFORE_CANCEL: "document-edit-before-cancel",
        AFTER_CANCEL: "document-edit-after-cancel"
    };

    /**
     * Триггеримые события на этапах валидации.
     */
    doc.edit.event = {
        BEFORE_VALIDATION: "document-before-validation",
        AFTER_SUCCESSFUL_VALIDATION: "document-after-successful-validation",
        AFTER_FAILED_VALIDATION: "document-after-failed-validation",
        AFTER_SUCCESSFUL_SAVE: "document-after-successful-save",
        AFTER_FAILED_SAVE: "document-after-failed-save",
        BEFORE_CANCEL: "document-edit-before-cancel",
        AFTER_CANCEL: "document-edit-after-cancel"
    }

    /**
     * Отменяет редактирование документа.
     * @param {string} unlockUrl URL для разблокирования документа.
     * @param {string} documentKey Идентификатор документа.
     */
    doc.edit.cancel = function (unlockUrl, documentKey) {
        var context = {
            documentKey: documentKey,
            unlockUrl: unlockUrl
        };

        $(document).trigger(doc.edit.event.BEFORE_CANCEL);
        invokeActions(context, doc.edit.actionType.BEFORE_CANCEL);

        $.post(unlockUrl, { documentKey: documentKey }, function (data) {
            $(document).trigger(doc.edit.event.AFTER_CANCEL);
            invokeActions(context, doc.edit.actionType.AFTER_CANCEL);

            window.location = returnUrl;
        });
    }

    /**
     * Сохраняет документ.
     * @returns {jQuery.Promise}
     */
    doc.edit.save = function () {
        var deferred = $.Deferred();

        var $form = $("form.edit-form");
        var formElement = $form[0];
        $form = $form.first();
        var formValidator = $form.parsley();

        var context = {
            $documentForm: $form,
            documentFormValidator: formValidator
        };

        $(document).trigger("beforeSave"); // Для обратной совместимости.
        $(document).trigger(doc.edit.event.BEFORE_VALIDATION);
       
        if (invokeActions(context, doc.edit.actionType.BEFORE_VALIDATION)) {
            formValidator.whenValidate().then(
                function () {
                    $(document).trigger(doc.edit.event.AFTER_SUCCESSFUL_VALIDATION);
                    if (invokeActions(context, doc.edit.actionType.AFTER_SUCCESSFUL_VALIDATION)) {
                        beforeSave();                       
                        ct.common.ajaxFormSubmit(
                            formElement,
                            function (data, afterSubj, errorMessage) {                          
                                $(document).trigger(doc.edit.event.AFTER_SUCCESSFUL_SAVE);                                 
                                if (invokeActions(context, doc.edit.actionType.AFTER_SUCCESSFUL_SAVE)) {

                                    // Затираем страницу редактирвоания из истории браузера
                                    history.replaceState({ page: 1 }, "", getBaseURI());

                                    if (errorMessage) {
                                        ct.common.showCommonErrors(errorMessage, function () { window.location = returnUrl }, true);
                                        afterSave();
                                    }
                                    else
                                        window.location = returnUrl;
                                }
                            },
                            function (data) {
                                $(document).trigger(doc.edit.event.AFTER_FAILED_SAVE);
                                if (invokeActions(context, doc.edit.actionType.AFTER_FAILED_SAVE)) {                                 
                                    ct.common.showCommonErrors(data.allMessages || data.responseText);                                   
                                    afterSave();
                                }
                            }
                        );                      
                    }                    
                    deferred.resolve(context);
                },
                function () {
                    $(document).trigger(doc.edit.event.AFTER_FAILED_VALIDATION);
                    invokeActions(context, doc.edit.actionType.AFTER_FAILED_VALIDATION);
                    
                    deferred.reject(context);
                }
            );
        }
              
        return deferred.promise();
    }

    // Для совместимости с IE
    function getBaseURI() {
        if (document.baseURI) return document.baseURI;
        var base = document.getElementsByTagName('base');
        if (base.length > 0) return base[0].href;
        return document.URL;
    }

    /**
     * Сохраняет проект.
     */
    doc.edit.saveProject = function () {
        var deferred = $.Deferred();

        var $form = $("form.edit-form");
        var formElement = $form[0];

        var context = {
            $documentForm: $form
        };

        $(document).trigger("beforeSave"); // Для обратной совместимости.
        $(document).trigger(doc.edit.event.BEFORE_VALIDATION);
        if (invokeActions(context, doc.edit.actionType.BEFORE_VALIDATION)) {
            beforeSave();            
            return ct.common.ajaxFormSubmit(
                formElement,
                function () {
                    $(document).trigger(doc.edit.event.AFTER_SUCCESSFUL_SAVE);
                    if (invokeActions(context, doc.edit.actionType.AFTER_SUCCESSFUL_SAVE)) {                       
                        window.location = returnUrl;
                        afterSave();
                    }
                    deferred.resolve(context);
                },
                function (data) {
                    $(document).trigger(doc.edit.event.AFTER_FAILED_SAVE);
                    if (invokeActions(context, doc.edit.actionType.AFTER_FAILED_SAVE)) {                       
                        ct.common.showCommonErrors(data.allMessages || data.responseText);
                        afterSave();
                    }
                    deferred.reject(context);
                }
            );
        }

        return deferred.promise();
    }

    /**
     * Добавляет в очередь action, вызываемый при сохранении.
     * @param {string} type Тип action'a, определяет, на каком этапе он будет вызван (до/после валидации и т.п.).
     * @param {function} func Тело action'a.
     * @param {string} name Имя action'a.
     * @param {number} orderIndex Индекс сортировки (определяет приоритет вызываемых action'ов, сначала вызываются с низким индексом, затем с более высоким)
     */
    doc.edit.addAction = function (type, func, name, orderIndex) {
        if (!isValidActionType(type)) {
            throw Error("Недопустимый actionType.");
        }
        if (!func) {
            throw Error("Action не определён.");
        }

        orderIndex = +orderIndex || 1000;
        var action = {
            id: ct.common.createId(8, "doc-action-"),
            type: type,
            func: func,
            orderIndex: orderIndex,
            name: name
        };
        _actions.push(action);
    }

    /**
     * Удаляет action'ы из очереди.
     * @param {Array<string>} ids Идентификаторы удаляемых action'ов.
     */
    doc.edit.removeActions = function (ids) {
        if (ids && ids.length) {
            _actions = _actions.filter(function (x) { return !~ids.indexOf(x.id); });
        }
    }

    /**
     * Удаляет action из очереди.
     * @param {string} id Идентификатор удаляемого action'a.
     */
    doc.edit.removeAction = function (id) {
        if (id) {
            doc.edit.removeActions([id]);
        }
    }

    /**
     * Возвращает массив имеющихся action'ов выбранного типа. Если тип не указан - возвращаются все имеющиеся.
     * @param {string} type Тип получаемых action'ов.
     */
    doc.edit.getActions = function (type) {
        if (type) {
            return _actions.filter(function (x) { return x.type === type; });
        } else {
            return _actions;
        }
    }

    window.adjustNewRowTextAreaHeight = function (newRow) {
        // при добавлении строки пересчитать высоту textarea
        newRow.find('.form-control__long-text--set-height').each(adjustTextAreaHeight);
    }

    var _actions = [];
    var loadingImageSelector = "#edit-form .loading-image";
    var returnUrl = $(".return-url").val();

    $(document).ready(function () {
        returnUrl = returnUrl ? returnUrl : $(".return-url").val();

        initLocalFilters();
        initTabs();
    });

    var initTabs = function () {
        // при активации спрятанных закладок пересчитать высоту textarea
        $('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
            $('.form-control__long-text--set-height')
              .each(adjustTextAreaHeight)
        });
        $('.form-control__long-text--set-height')
             .each(adjustTextAreaHeight);
    }
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																					
    // добавим для полей textarea высоту для полного отображения текста
    var adjustTextAreaHeight = function (index, c) {
      /*  var control = $(c);
        if (control.get(0).scrollHeight > 0) {
            control.height(control.get(0).scrollHeight);
        } */
        $(c).each(function () {
			if (this.scrollHeight > 0) {
				this.setAttribute('style', 'height:' + (this.scrollHeight) + 'px;overflow-y:hidden;');
			}
          }).on('input', function () {
			 if (this.scrollHeight > 0) {
				this.style.height = 'auto';
				this.style.height = (this.scrollHeight) + 'px';
			 }
          });
    }


    
    var initLocalFilters = function () {

        localFilter.items = [];
        var localFilters = $(".table-filter-row");
        if (localFilters.length) {
            for (var i = 0; i < localFilters.length; i++) {
                var filter = localFilters[i];
                var item = {
                    id: filter.id,
                    name: $(filter).attr("data-name"),
                    columns: [],
                    timer: null,
                };
                localFilter.items.push(item);

                var filterControls = $(filter).find(".table-filter-column .local-filter__input");
                if (filterControls.length) {
                    for (var j = 0; j < filterControls.length; j++) {
                        var control = filterControls[j];

                        var isCheckbox = $(control).hasClass("local-filter__checkbox");
                        if (isCheckbox) {
                            //$(control).prop("indeterminate", true);
                            //$(control).prop("readOnly", true);
                        }

                        var isCheckboxDict = $(control).hasClass("local-filter__checkbox-dict"); 

                        item.columns.push({
                            name: control.name,
                            isCheckbox: isCheckbox,
                            isCheckboxDict: isCheckboxDict,
                            value: $(control).val().toString()
                        });

                        // checkboxes    
                        if (isCheckbox) {
                            var filterTimer = item;
                            $(control).change({ filterName: item.name }, function (event) {
                                var input = $(this);
                                var inputValue = input.val();
                                localFilterChanged(filterTimer, event.data.filterName, input.attr("name"), inputValue);
                            }); // subscribe to change event
                        } else { // other filters
                            var filterTimer = item;
                            $(control).keyup({ filterName: item.name }, function (event) {
                                var input = $(this);
                                var inputValue = input.val();
                                localFilterChanged(filterTimer, event.data.filterName, input.attr("name"), inputValue);
                            }); // subscribe to change event
                        }
                    }
                }

                // datepickers
                var datepickersControls = $(filter).find(".table-filter-column .local-filter__datepicker");
                if (datepickersControls.length) {

                    for (var k = 0; k < datepickersControls.length; k++) {
                        var datepicker = $(datepickersControls[k]);
                        var dataFieldName = datepicker.attr("data-field-name");
                        var filterName = item.name;
                        var filterTimer = item;
                        datepicker.on('dp.change', function (e) {
                            var dp = $(this);
                            var inputForDatepicker = dp.find(".local-filter__input");
                            if (inputForDatepicker.length == 1) {
                                var input = inputForDatepicker.first();
                                var inputValue = input.val();
                                localFilterChanged(filterTimer, filterName, input.attr("name"), inputValue);
                            }
                            else {
                                console.log("!!! input with name " + dataFieldName + (inputForDatepicker.length == 0 ? " not found!" : " is not unique!"));
                            }
                        });
                    }
                }
            }
        }
    }

    

    var localFilterChanged = function (filterTimer, filterName, propertyName, propertyValue) {

        if (filterTimer.timer != null) {
           clearTimeout(filterTimer.timer);
        }

        setFilterValue(filterName, propertyName, propertyValue);

        filterTimer.timer = setTimeout(function() {
            applyFilter(filterName);
        }, 300);
    }


    var setFilterValue = function (filterName, propertyName, propertyValue) {

        localFilter.items.filter(function (f) { return f.name == filterName }).forEach(function (filter) {
            filter.columns.forEach(function (column) {
                if (column.name == propertyName) {
                    column.value = propertyValue.toString().toLowerCase();
                    return;
                }
            })
        });
    }

    var applyFilter = function (filterName) {
        var filteredClassName = "local-filter__input_filtered";

        localFilter.items
            .filter(function (f) { return f.name == filterName })
            .forEach(function (filter) {

                var table = $("div[data-name='" + filter.name + "']");
                table.find("div.table-edit-row[data-rowkey]").each(function () {

                    var selected = true;
                    var row = $(this);
                    var id = row.attr("data-rowkey");

                    filter.columns.forEach(function (column) {
                        var input = $("[data-field-name='" + column.name + "-" + id + "']");
                        if (input) {
                            if (column.value != "") {

                                if (column.isCheckboxDict) {
                                    if (!matchCheckDictionary(column.value, input)) {
                                        selected = false;
                                    }
                                }
                                else if (column.isCheckbox) {
                                    if (!matchCheck(column.value, input)) {
                                        selected = false;
                                    }
                                } else {
                                    if (!matchText(column.value, input.val())) {
                                        selected = false;
                                    }
                                }
                            }

                            if (selected) {
                                if (row.hasClass(filteredClassName)) {
                                    row.removeClass(filteredClassName);
                                }
                            }
                            else {
                                if (!row.hasClass(filteredClassName)) {
                                    row.addClass(filteredClassName);
                                }
                            }
                        }
                        else {
                            console.log(column.name + "-" + id + " not found");
                        }
                    });
                });
            });
    }

    var matchText = function (filterValue, inputValue) {
        if (inputValue == undefined || inputValue == null) {
            return false;
        }
        return inputValue.toString().toLowerCase().includes(filterValue);
    }

    var matchCheck = function (filterValue, inputControl) {
        var checked = inputControl.is(":checked");
        return (filterValue == "on" && checked) || (filterValue == "off" && !checked);
    }

    var matchCheckDictionary = function (filterValue, input) {
        var inputValue = input.find("option:selected").text().trim();
        return matchText(filterValue, inputValue);
    }

    function invokeActions(context, type) {
        var actionsToInvoke = _actions.filter(function (x) { return x.type === type; });
        actionsToInvoke.sort(compareActions);

        if (actionsToInvoke.length) {
            var invoked = [];
            var idx = 0;
            var isRunning = true;
            var stopPipeline = false;
            while (isRunning) {
                var currentAction = actionsToInvoke[idx];
                var isCurrentActionAlreadyInvoked = ~invoked.indexOf(currentAction.id);
                if (!isCurrentActionAlreadyInvoked) {
                    currentAction.func(
                        context,
                        function () {
                            idx++;
                        },
                        function () {
                            stopPipeline = true;
                        }
                    );
                    invoked.push(currentAction.id);
                }
                isRunning = stopPipeline || isCurrentActionAlreadyInvoked ? false : idx < actionsToInvoke.length;
            }
            if (stopPipeline) {
                if (ct.debug) {
                    console.info("Конвейер action'ов остановлен.");
                }
                return false;
            }
            if (ct.debug && (actionsToInvoke.length !== invoked.length)) {
                console.warn("Выполнены не все action'ы конвейера. Возможно, пропущен вызов next() в action'e ", currentAction);
            }
        }
        return true;
    }

    function isValidActionType(type) {
        for (var key in doc.edit.actionType) {
            if (doc.edit.actionType[key] === type) {
                return true;
            }
        }
        return false;
    }

    function compareActions(a, b) {
        if (a.orderIndex < b.orderIndex) {
            return -1;
        }
        if (a.orderIndex > b.orderIndex) {
            return 1;
        }
        return 0;
    }

    function beforeSave() {
        $("form.edit-form button.save-editing-doc").prop("disabled", true);

        // если чекбокс true, скрытое поле с false надо убрать
        $("form")
            .find(".checkbox-wrapper input[type=checkbox]")
            .each(function (num, element) {
                var chBox = $(element);
                if (chBox.is(":checked")) {
                    chBox.siblings().removeAttr("name");
                }
            });
        showLoadingIndicator(loadingImageSelector);
    }

    function afterSave() {
        hideLoadingIndicator(loadingImageSelector);
        $("form.edit-form button.save-editing-doc").prop("disabled", false);
    }
}((window.ct = window.ct || {}, window.ct.document = window.ct.document || {})));
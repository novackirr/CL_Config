function debounce(n,t){var i=null;return function(){clearTimeout(i);var r=arguments,u=this;i=setTimeout(function(){n.apply(u,r)},t)}}var HierarDictionary=function(n,t,r){function ui(){Ext.define("LiteClient.Proxy",{extend:"Ext.data.proxy.Ajax",getExtraParams:function(){var n=rr(rt);return n.selectedNodes=c,dt&&(n.rootId=dt),n},processResponse:function(n,t,i,r){var s,c;(w&&w.prop("disabled",!1),r.aborted)||(vt!=""?r.responseText=vt:(s=wr(JSON.parse(JSON.parse(r.responseText).data)),br(s),typeof handleCustomDictionary!="undefined"&&handleCustomDictionary(s,u.attr("data-dict-name")),r.responseText=JSON.stringify(s)),this.superclass.superclass[arguments.callee.$name].apply(this,[n,t,i,r]),h&&f&&(c=h.snapshot||h.data,f.forEach(function(n){c.forEach(function(t){if(t.get(o.CodeKey)===n.get(o.CodeKey)){var i=f.indexOf(n);i>-1&&(f[i]=t);t.set("checked",!0);t.modified={};e.view.refreshNode(t)}})})))}});var n=Ext.create("LiteClient.Proxy",{reader:p.reader,url:encodeURI(a),timeout:2e5,paramOrder:"parentId",filterParam:"filterParams",actionMethods:{read:"POST"}});h=p.createStore(n,ht)}function tr(){for(var n="",t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",i=0;i<5;i++)n+=t.charAt(Math.floor(Math.random()*t.length));return n}function ir(){var d,g,tt,it,o,i,et,gt,ii,ui,ei,oi,hi,ct,ci,li,ai,h,n,at,vi,vt,yt,l,f,y,e,pt,w,b,wt,kt,k;if(ft=!0,nf(),Ext.define("OverrideHeaderResizer",{override:"Ext.grid.plugin.HeaderResizer",maxColWidth:9999}),s=tr(),hr(),Ext.getBody().mask("Загрузка словаря..."),u.attr("data-panelWidth")&&(bt=u.attr("data-panelWidth")*1),a=u.attr("data-url"),d=parseInt(window.location.pathname.split("/").pop()),isNaN(d)||(a+="&documentKey="+d),rt=u.attr("data-fields"),ut=u.attr("data-edit-template"),dt=u.attr("data-root-ids"),g=u.attr("data-is-virtual-grid"),g&&g.toUpperCase()==="TRUE"?(ft=!0,p=ni,ht=u.attr("data-vg-page-size")?parseInt(u.attr("data-vg-page-size")):200,ht<30&&(ht=30)):p=nr,tt=u.attr("data-permanent-filters"),tt)for(it=JSON.parse(tt),o=0;o<it.length;o++)i=it[o],et=nt.filter(function(n){return n.property==i.property})[0],et!=undefined?et.value.push(i.value):nt.push({property:i.property,value:[i.value]});if(gt=u.attr("data-multiple"),gt&&(v=!0),ii=u.attr("data-table-output"),ii&&(lt=!0),ui=u.data("childrenselection"),v&&ui&&(ri=!0),!(a===undefined)){var fi=u.closest(".table-edit"),yi=fi.length>0,ot=u.closest("form"),st='[name="'+u.attr("id")+'"]',pi='[name="'+u.attr("id")+'Name"]';yi&&(ei=fi.attr("data-name"),oi=u.closest(".table-edit-row").attr("data-rowkey"),st='[name="'+ei+"-"+u.attr("id")+"-"+oi+'"]');try{u.hasClass("table-form-button")&&(hi=u.closest(".dict-modal-control").children(".dict-display-field").attr("data-field-name"),ct=hi.split("-"),st='[name="'+ct[0]+"-"+u.attr("id")+"-"+ct[2]+'"]',ot=u.closest(".documentView-field-value"))}catch(rr){}if(r&&r.selectedNodes?c=r.selectedNodes:v===!1?(ci=$(ot).find(st).val(),c.push(ci),gi=$(ot).find(pi).val()):(li=u.closest("div").find("ul li input"),ai=li.filter(function(n,t){var i=$(t).attr("name").split("-")[1];return $(t).val()!==""&&i===u.attr("id")}),$(ai).each(function(n,t){c.push($(t).val())})),h=u.attr("parent-id"),h!==undefined&&h!=null){if(n=fr(h),at=n?n.val():undefined,at===undefined||(a+="&parentId="+at),n&&n.length>0)n.on("change",function(n){if(!n){var t=u.closest(".table-edit"),i=t.length>0,r=t.attr("data-name"),f=u.closest(".table-edit-row").attr("data-rowkey"),e=u.attr("id");ti(e,i,r,f)}});vi=or(u);a+="&subDictionaries="+vi+""}if(vt=$("input[name='uniqueIds']").val(),yt=$("input[name='objectType']").val(),vt!==undefined&&(yt===undefined||yt==="document")&&(a+="&documentKey="+vt),l=u.attr("dictionary-selection-start-level"),l!==undefined&&l!==null&&(a+="&selectionStartLevel="+l),f={},y=u.attr("data-form-values"),y!==undefined&&y!==null){e=y.split(",");pt=u.closest(".table-edit-row");for(w in e)b=$("[name='"+e[w]+"']").map(function(n,t){var i=$(t);return i.val()}).filter(function(n,t){return t!==""}).toArray().join(),!b&&pt.length>0&&(wt=pt.find("input").filter(function(){var n=$(this).attr("name"),t=new RegExp(".+-"+e[w]+"-\\d+");return t.test(n)}),wt.length>0&&(b=wt.val())),f[e[w]]=b}if(kt=u.closest(".table-edit > .table-content"),kt.length>0&&(k=kt.closest(".table-edit-row"),k.length>0)){var wi=k.attr("data-rowKey"),bi=u.attr("parent-table-edit-name"),ki=u.attr("parent-table-key-attr"),di="input[name='"+bi+"-"+ki+"-"+wi+"']",ir=k.find(di);f.Code=ir.val()}ur(f)||(a+="&formValues="+JSON.stringify(f));t!=null?vr(si):lr(c,si)}}function rr(n){return n.split("&").reduce(function(n,t){var i=t.split("=");return n[i[0]]=i[1],n},{})}function ur(n){for(var t in n)if(n.hasOwnProperty(t))return!1;return JSON.stringify(n)===JSON.stringify({})}function fr(n){for(var r=n+"parent",u=$("[data-parent-name='"+r+"']"),t,i,f,e;!u.length;)if(t=n.split("-"),i=t.length,i<=3){if(i<=1)return null;r=t[1]+"parent";u=$("[data-parent-name='"+r+"']");break}else f=t.slice(0,i-4),e=f.join("-"),n=e+"-"+t[i-2]+"-"+t[i-4],r=n+"parent",u=$("[data-parent-name='"+r+"']");return u}function er(n){for(var r=$("input[name='"+n+"'], textarea[name='"+n+"']"),t,i,u,f;!r.length;)if(t=n.split("-"),i=t.length,i<=3){if(i<=1)return null;n=t[1];r=$("input[name='"+n+"'], textarea[name='"+n+"']");break}else u=t.slice(0,i-4),f=u.join("-"),n=f+"-"+t[i-2]+"-"+t[i-4],r=$("input[name='"+n+"'], textarea[name='"+n+"']");return r}function or(n){for(var t=[],i;n!=undefined;)i=n.attr("data-subdictionary-name"),t.push(i==undefined?"":i),n=sr(n);return t.pop(),t}function sr(n){var i=n.attr("parent-id"),t,r;return i==undefined?undefined:(t=er(i),!t)?undefined:(r=t.parent().find("button")[0],$(r))}function hr(){u.prop("disabled",!0)}function tt(){u.prop("disabled",!1)}function cr(){var n=e,r=y,t=$(".dictionary-item-form").first(),i=t.parsley();i.whenValidate().done(function(){ajaxFormSubmit($(".dictionary-item-form")[0],function(t){var r=JSON.parse(t),u,f;Ext.getCmp("DictWind"+s).unmask();var o=n.store.getRootNode(),i=n.store.getNodeById(r.id),h=!1;if(i==undefined)o.appendChild(r),i=n.store.getNodeById(r.id),h=!0;else for(u in r)i.data.hasOwnProperty(u)&&i.set(u,r[u]);i!=null&&(o.cascadeBy(function(n){var t=n.get("checked");t&&n.set("checked",!1)}),i.set("checked",!0),yt(i));y.setHidden(!0);e.setVisible(!0);h&&(f=n.body.dom.firstElementChild,f.scrollTop=f.scrollHeight-f.clientHeight)},function(n){Ext.getCmp("DictWind"+s).unmask();k("Произошла ошибка",n.responseText)},function(){Ext.getCmp("DictWind"+s).mask("Сохранение...")})})}function lr(n,t){var i;if(w&&w.prop("disabled",!0),i=n.some(function(n){return n?!0:!1}),p===ni&&i){var e=encodeURI(a),r=parseInt(window.location.pathname.split("/").pop()),u=encodeURI(rt+"&code="+n.join(","));isNaN(r)||(u+="&documentKey="+r);$.ajax({type:"POST",dataType:"json",url:e,data:u}).done(function(n){if(n.error||n.status&&n.status.toLowerCase()==="error"){k("Произошла ошибка",n.error||n.responseMessage);tt();Ext.getBody().unmask();return}var i=JSON.parse(n.data);f=i.children;f.forEach(function(n){n.raw=n;n.get=function(t){return n[t]}});fi(t)})}else fi(t)}function fi(n){var r=encodeURI(a),t=parseInt(window.location.pathname.split("/").pop()),i=encodeURI(rt+"&start=0&limit=1");isNaN(t)||(i+="&documentKey="+t);$.ajax({type:"POST",dataType:"json",url:r,data:i}).done(function(t){if(t.error||t.status&&t.status.toLowerCase()==="error"){k("Произошла ошибка",t.error||t.responseMessage);tt();Ext.getBody().unmask();return}var i,r=u.attr("spec-show-dict");if(r?(vt=loadDictionaryDataSpec(),i=JSON.parse(vt)):i=JSON.parse(t.data),typeof handleCustomDictionary!="undefined"&&handleCustomDictionary(i,u.attr("data-dict-name")),i.children==null||i.children.length===0){switch(u.attr("data-dict-name")){case"Контрагенты для счетов":showCommonErrors("Для выбора контрагента для счёта, сначала необходимо выбрать Предполагаемого контрагента/Контрагента.");break;default:k("Данный словарь пуст","Данный словарь не содержит ни одного значения")}tt();Ext.getBody().unmask();return}o=ei(i);Ext.getBody().unmask();n()}).fail(function(){k("Ошибка","Произошла непредвиденная ошибка");tt();Ext.getBody().unmask()})}function ar(n){var t=encodeURI(a),i=encodeURI(rt+"&start=0&limit=1&id="+n);return $.ajax({type:"POST",dataType:"json",url:t,data:i})}function vr(n){if(t.data.children==null||t.data.children.length===0){k("Данный словарь пуст","Данный словарь не содержит ни одного значения");tt();Ext.getBody().unmask();return}o=ei(t.data);Ext.getBody().unmask();n()}function ei(n){var t=n.fieldsInfo.DictionaryFieldInfoList,i=t.filter(function(n){return n!=null&&n.DictColumnName!=="code"&&n.ShowAsDictionaryColumn===!0});return kt=i,n}function yr(n){var i=null,u=n.fieldsInfo.DictionaryFieldInfoList.length,t,r;if(u===1)i=n.fieldsInfo.DictionaryFieldInfoList[0].EditName;else for(t=0;t<u;t++)if(r=n.fieldsInfo.DictionaryFieldInfoList[t],r.DictColumnName===n.CodeKey){i=r.EditName;break}return i}function pr(n,t,i){var r=t.codes.indexOf(n[t.columnName||i]);return r!==-1&&t.isShow||r===-1&&!t.isShow}function oi(n,t,i,r,u){var f,o,e,h,s;if(!n)return null;if(f={},u===0||pr(n,r,i)){if(f=n,n[t]!=null){for(o=[],e=0;e<n[t].length;e++)h=n[t][e],s=oi(h,t,i,r,u+1),s!=null&&o.push(s);f[t]=o}return f}return null}function wr(n){var r=yr(n),t=null,i,u;return r&&(i=$("#"+r+"_allowed_items"),i.length===1&&(u=JSON.parse(i.val()),t=oi(n,n.ChildrenKey,n.CodeKey,u,0))),t!==null?t:n}function k(n,t){Ext.Msg.alert(n,t)}function si(){kr();wu()}function br(n){return n&&n.children&&r&&r.disabledNodes&&r.disabledNodes.length&&n.children.forEach(function(n){~r.disabledNodes.indexOf(n[o.CodeKey])&&(n.enabled=!1)}),typeof handleCustomDictionary!="undefined"&&handleCustomDictionary(n),n}function kr(){function n(t){t!==null&&t.parentNode!==undefined&&t.id!=="root"&&(t.expand(),n(t.parentNode))}var r=hu(),i;Ext.define("Dictionary",r);t==undefined?ui():h=Ext.create(p.storeType,{model:"Dictionary",data:t.data.children,root:{},proxy:{type:"memory",reader:{type:"json"}}});eu(h);i=function(t,i){var r=h.getRootNode();r.cascadeBy(function(t){if(t.get("enabled")||t.set("checked",null),c.indexOf(t.data.code)>-1){t.set("checked",!0);g[t.data.code]=t;var i=t.getOwnerTree();i.wasFocusedOnce||setTimeout(function(){t.getOwnerTree().getView().focusRow(t)},0);i.wasFocusedOnce=!0;wt=t;di=t;n(t)}else t.data.children&&t.data.children.length>0&&n(t)});uu(i)};st=[{text:"Выбрать",cls:"dialogChooseBtn",handler:p.chooseButtonHandler},{text:"Отмена",cls:"dialogCancelBtn",handler:function(){it()}}];ut!=undefined&&st.unshift({text:"Добавить",cls:"dialogAddBtn",align:"left",handler:function(){var n=this.up("treepanel");nu(n)}});e=Ext.define("Ext.filteredTree",{id:"treePanel"+s,extend:p.panelType,store:h,autoWidth:!0,autoHeight:!1,height:555,rootVisible:!1,hideHeaders:!1,useArrows:!0,disableSelection:!0,listeners:{load:i,checkchange:gr,itemclick:dr},buttons:st,initComponent:function(){pu(this)},filterStore:su,strMarkRedPlus:function(n,t){return t.replace(new RegExp("("+n+")","gi"),"<span style='color: red;'><b>$1<\/b><\/span>")}})}function yt(n){var u=n.getTreeStore(),i,s,r,h,l,a,t;if(v==!1)c=[],g={},t=n.get("code"),n.get("checked")&&(c.push(t),g[t]=n),u==null?(i=n,i.modified={},s=!n.get("checked"),r=i.get(o.CodeKey),s?(h=f.filter(function(n){return n.get(o.CodeKey)===r}),h.forEach(function(n){var t=f.indexOf(n);t!==-1&&f.splice(t,1)})):v?f.push(i):(f.forEach(function(n){if(n.get(o.CodeKey)!==r&&n.set){n.set("checked",!1);n.modified={};try{e.view.refreshNode(n)}catch(t){}}}),f=[i]),e.view.refreshNode(i)):(l=u.getRootNode(),l.cascadeBy(function(t){t.id!==n.id&&t.get("enabled")?t.set("checked",!1):t.isRoot()&&t.set("checked",null)}));else if(c&&c.indexOf(n.get("code"))>-1)n.set("checked",!1),a=c.indexOf(n.get("code")),c.splice(a,1);else{if(!n.get("enabled")){var p=n.get("code"),w=o.disabledTextDictionary,y=ai(w,p);k("Невозможно выбрать элемент",y==null?"Элемент недоступен для выбора":y)}t=n.get("code");n.set("checked",!0);c.push(t);g[t]=n}}function nu(n){n.setHidden(!0);var t=u.attr("data-edit-url");hi(t)}function hi(n){y.body.load({url:n,scripts:!0,callback:function(){y.setVisible(!0);enableToolTips();updateDatepickers();fillDictDisplayValues();bindDictionaryDisplayField();addParsleyValidation(".dictionary-item-form")}})}function tu(){var n=getAbsoluteUrl("/Dictionary/GetDictionaryForm?template=SupSearchForm.xml");at?l.setVisible(!0):l.body.load({url:n,scripts:!0,callback:function(){enableToolTips();updateDatepickers();fillDictDisplayValues();bindDictionaryDisplayField();addParsleyValidation(".dictionary-item-form");l.setHidden(!1);at=!0;l.setHeight(l.height+100)}})}function iu(){var n=u.attr("id"),l=u.closest(".table-edit"),t=l.length>0,i=l.attr("data-name"),r=u.closest(".table-edit-row").attr("data-rowkey"),s,c;if(lt&&(t=!1),s=function(u){v?yi(u,n,t,i,r):vi(u[0],n,t,i,r)},typeof ExtContractorManager!="undefined")if(f.length>=1)if(c=f[0],c.data.hasOwnProperty("source")&&(n=="orgpost2"||n=="orgposttable")){var a=c.get(o.CodeKey),y=ExtContractorManager(h,e,b),p=c.data["ИНН"],w=c.data["Наименование"];y.saveChoosenContractor(a,f,s,p,w,ar,function(){it()},function(){et(!0,n,t,i,r,s);d.resolve(f)},function(){et(!1,n,t,i,r,s);d.resolve(f)})}else et(!0,n,t,i,r,s),it(),d.resolve(f);else et(!1,n,t,i,r,s),it(),d.resolve(f);else et(!0,n,t,i,r,s),it(),d.resolve(f);lt&&fillMultipleDictFieldsToTable(n,t,i,r,u)}function et(n,t,i,r,u,e){!n||f.length===0||f[0].id==="root"&&f.length===1?(v?li(t):ti(t,i,r,u),$(pt(t,i,r,u)).val("").change(),$('input[dictionary-edit-name="'+t+'"].readonly-field:visible, textarea[dictionary-edit-name="'+t+'"].readonly-field:visible').val("").change()):(ci(t,f),e(f))}function ru(n){var h=n.getStore(),l=h.getRootNode(),i=u.attr("id"),s=u.closest(".table-edit"),r=s.length>0,f=s.attr("data-name"),e=u.closest(".table-edit-row").attr("data-rowkey"),t=[];$(c).each(function(n,i){g[i]&&t.push(g[i])});t.length===0||t[0].id==="root"&&t.length===1?(v?li(i,r,f,e):ti(i,r,f,e),$(pt(i,r,f,e)).val("").change()):(ci(i,t),$(t).each(function(n,t){if(!t.get("enabled")){var r=t.get("id"),u=o.disabledTextDictionary,i=ai(u,r);k("Невозможно выбрать элемент с id",i==null?"Элемент недоступен для выбора":i);return}}),v?yi(t,i,r,f,e):vi(t[0],i,r,f,e));it();d.resolve(t)}function ci(n,t){var i={dicName:u.attr("data-dict-name"),items:t.slice()};u.trigger("DicItemSelected",i)}function uu(n){var t={dictButton:u,items:n};u.trigger("DicDialogOpened",t)}function it(){b.close();u.parents(".modal").length>0?$("body").addClass("modal-open"):$("body").removeClass("modal-open")}function ti(n,t,i,r){o&&o.fieldsInfo&&o.fieldsInfo.DictionaryFieldInfoList&&$.each(o.fieldsInfo.DictionaryFieldInfoList,function(n,u){var e=u.EditName,o=u.DictColumnName,f=$(wi(e,t,i,r));f!=null&&(f.is(":checkbox")&&wt!==undefined?wt.get(o)==="1"&&f.prop("checked",f.prop("checked")===!0?!1:!0).change():f.val("").change())})}function li(n,t,i,r){var e,f,o;t?(e="[data-field-name='"+i+"-"+n+"-"+r+"']",f=$(e).parent().parent().closest(".dict-modal-control")):f=$("#"+n).closest(".dict-modal-control");lt&&(f=u.closest(".dict-modal-control"));f.find(".mult-dict-display").val("").change();f.find("ul").html("");o=f.attr("data-edit-name");ct.common.dictionary.fillMultipleDictFieldsByList(f,o)}function ai(n,t){var i,r;for(i in n)if(n.hasOwnProperty(i)&&(r=n[i],$.inArray(t,r)!==-1))return i;return null}function vi(n,t,i,r,f){$.each(o.fieldsInfo.DictionaryFieldInfoList,function(t,u){var s=u.DictColumnName,c=u.EditName,e=$(wi(c,i,r,f)),o,h;if(e!=null)if(e.is(":checkbox"))e.prop("checked",n.get(s)==="1"?!0:!1).change();else if(e.hasClass("money")||e.hasClass("number")){if(o=n.get(s),o){if(h=e.hasClass("money")||e.attr("data-number-type")=="double"?parseFloat(o).toFixed(2):parseInt(o,10),isNaN(h)){window.alert("Ошибка! Неверный тип значения");return}e.autoNumeric("set",h)}e.change()}else e.val(n.get(s)).change()});fillDipslayValueForDict(u.closest(".dict-modal-control"));$(pt(t,i,r,f)).val(n?n.get("id"):"").change()}function yi(n,t,i,r,f){var c=u.closest("div").find("ul.multiple-editor-list"),v=u.attr("data-dict-name"),e=u.attr("data-dictTableName"),l=[],a,p;c.html("");var s=1,h={},y=$('<div><hr class="action-separator"/><span class="action-container"><button title="очистить список" id="removeItemsAll-bottom" type="button" class="btn btn-default" onclick="ct.common.dictionary.removeAllEx(this); setPreventDefault(event); "><i class="glyphicon glyphicon-trash"><\/i><\/button><\/span><\/div>');$(n).each(function(t,a){l.push(a.get("id"));var p=$("<li><\/li>"),b=$('<a href="#" onclick="stopEvent(this); setPreventDefault(event);" class="dictionary-list-item"><\/a>'),k=$('<div onclick="ct.common.dictionary.removeFromMultipleDisplayFieldsEx(this); stopEvent(this);" class="multiple-editor-remove glyphicon glyphicon-remove"><\/div>'),w="";$.each(o.fieldsInfo.DictionaryFieldInfoList,function(n,t){var nt=t.DictColumnName,b="",k,o,l,y,d,c,g;i?(k=/-/gi,b=e+":"+r.replace(k,":")+"-"+t.EditName+"-"+f+"-"+s):b=e+"-"+t.EditName+"-"+s;o=a.get(nt);l="[name='"+t.EditName+"']:visible";e&&(e.indexOf("formItemTab")>-1||u.hasClass("table-form-button"))&&(y=e.split("-"),b=y[1]+":"+y[0]+"-"+t.EditName+"-"+y[2]+"-"+s,l="[name='"+y[0]+"-"+t.EditName+"-"+y[2]+"']");d=$(l);d.length>0&&(h[l]?o&&(h[l]+=", "+o):h[l]=o);c=$('<input type="hidden" readonly/>');c.val(o);c.attr("dictionary-edit-name",v);t.ShowAsDisplayText===!0&&(c.addClass("display-field-part"),w===""?w=o:w+=ct.common.dictionary.VIEW_DATA_SEPARATOR+o);g=i?b:b;c.attr("name",g);c.val(o).change();p.append(c)});b.append(w);p.append(b);p.append(k);n.length==s&&p.append(y);c.append(p);s++});c.append(y);for(a in h)$(a).val(h[a]);ct.common.dictionary.fillMultipleDictFieldsByList(u.closest(".dict-modal-control"),v);p=l.length>0?l.join(ct.common.dictionary.DATA_SEPARATOR):"";$(pt(t,i,r,f)).val(p).change()}function pi(n,t,i,r,f){var s=u.attr("id"),e=i?r+"-"+n+"-"+f:n,h,o;try{u.hasClass("table-form-button")&&(h=u.closest(".dict-modal-control").children(".dict-display-field").attr("data-field-name"),o=h.split("-"),e=o.length==3?o[0]+"-"+n+"-"+o[2]:o[0]+"-"+n)}catch(c){}return t?"input[data-parent-name='"+e+"parent'], textarea[data-parent-name='"+n+"parent']":"input[name='"+e+"'][dictionary-edit-name='"+s+"'], input[name='"+e+"'][alt-dictionary-edit-name='"+s+"'], textarea[name = '"+e+"'][dictionary-edit-name='"+s+"']"}function wi(n,t,i,r){return pi(n,!1,t,i,r)}function pt(n,t,i,r){return pi(n,!0,t,i,r)}function fu(n,t){var i=[{property:t,sorterFn:function(i,r){var f=function(i){var r=i.get(t).toLowerCase(),u=r.search(n);return r.substring(0,n.length)===n&r.substring(n.length,n.length+1)===" "?1:r.substring(0,n.length)===n?2:r.substring(u-1,u)===" "&r.substring(u+n.length,u+n.length+1)===" "?3:4},u=function(n){var i=n.childNodes,r,e,o,t=f(n),s,h;t===1&&(r=1);t===2&&(e=2);t===3&&(o=3);for(s in i)h=i[s].childNodes,t=f(i[s]),t===1&&(r=1),t===2&&(e=2),t===3&&(o=3),h!==[]&&(t=u(i[s]),t===1&&(r=1),t===2&&(e=2),t===3&&(o=3));return r===1?1:e===2?2:o===3?3:4},e=u(i),o=u(r);return e===o?0:e<o?-1:1}}];h.sort(i)}function bi(){var n=[],t;if(nt&&nt.length>0)for(i=0;i<nt.length;i++)t=new Ext.util.Filter(nt[i]),n.push(t);return n}function eu(n){var t=bi();n.getFilters().add(t)}function ot(n){var i=n.getFilters().items,t=i.filter(function(n){return n.config.property==="search"});t&&t.length&&t[0]&&e.store.getFilters().remove(t[0])}function ou(n,t){var i=bi();i.push(t);n.filter(i)}function su(n){function u(n){for(var r=0;r<t.columns.length;r++)fu(i,t.columns[r].dataIndex,n)}var t=this,i=n.toLowerCase(),r;i.length===0&&ot(t.store);r=new Ext.util.Filter({property:"search",value:[i]});ou(t.store,r);ft&&u(t.store)}function hu(){var n={extend:"Ext.data.TreeModel",fields:[{name:o.IdKey,type:"string"},{name:o.CodeKey,type:"string"},{name:"checked",defaultValue:!1},]};return $.each(kt,function(t,i){n.fields.push({name:i.DictColumnName,type:"string"})}),n}function cu(n){var i=u.attr("data-dict-name"),t=[],r;return o.codeColumnVisible&&(r=i!=null&&i.length>0?i:"Код",t.push({header:r,flex:2,sortable:ft,width:parseInt(o.codeColumnWidth)/100*ii,hideable:!1,dataIndex:o.CodeKey,renderer:ki(r),scope:n})),$.each(kt,function(i,r){t.push({text:r.DictColumnName,flex:parseInt(r.DictColumnWidth/10),hideable:!1,sortable:ft,dataIndex:r.DictColumnName,renderer:ki(r.DictColumnName),scope:n,width:parseInt(r.DictColumnWidth)/100*ii})}),t.length>0&&(t[0].xtype=p.columnXtype,t[0].cellTpl=au()),p===ni&&t.splice(0,0,{xtype:"templatecolumn",dataIndex:"checked",width:ut!=undefined?60:40,tpl:lu(),hideable:!1,listeners:{click:function(n,t,i){var s=n.up("grid"),h=s.getStore().getAt(i).get("checked"),r=s.getStore().getAt(i),u,c;r.set("checked",!h);r.modified={};u=r.get(o.CodeKey);h?(c=f.filter(function(n){return n.get(o.CodeKey)===u}),c.forEach(function(n){var t=f.indexOf(n);t!==-1&&f.splice(t,1)})):v?f.push(r):(f.forEach(function(n){n.get(o.CodeKey)!==u&&n.set&&(n.set("checked",!1),n.modified={},e.view.refreshNode(n))}),f=[r]);e.view.refreshNode(r)}},editor:{xtype:"checkbox",cls:"x-grid-checkheader-editor"}}),t}function lu(){var n,t;return ut!=undefined&&(n='<div role="button" class="edit-btn-'+s+'  x-tree-icon x-tree-icon-edit"/><\/div>'),t=["<div>",'<tpl if="checked !== null">','<div role="button" class=" x-tree-checkbox x-tree-checkbox<tpl if="checked">-checked<\/tpl>"><\/div>',n,"<\/tpl>",'<tpl if="checked === null">','<div role="presentation" class=" x-tree-checkbox x-tree-checkbox disabled"/>',"<\/tpl>","<\/div>"],t.join("")}function au(){var n,t,i;return ut!=undefined&&(n='<div role="button" class="edit-btn-'+s+'  x-tree-icon x-tree-icon-edit"/><\/div>'),t=['<tpl if="checked !== null">','<div role="button" {ariaCellCheckboxAttr}',' class="{childCls} {checkboxCls}<tpl if="checked"> {checkboxCls}-checked<\/tpl>"><\/div>',n,"<\/tpl>"],i=['<tpl if="checked === null">','<div role="presentation" {ariaCellCheckboxAttr}',' class="{childCls} {checkboxCls} disabled"><\/div>',"<\/tpl>"],['<tpl for="lines">','<div class="{parent.childCls} {parent.elbowCls}-img ','{parent.elbowCls}-<tpl if=".">line<tpl else>empty<\/tpl>" role="presentation"><\/div>',"<\/tpl>",'<div class="{childCls} {elbowCls}-img {elbowCls}','<tpl if="isLast">-end<\/tpl><tpl if="expandable">-plus {expanderCls}<\/tpl>" role="presentation"><\/div>',t.join(""),i.join(""),'<tpl if="icon"><img src="{blankUrl}"<tpl else><div<\/tpl>',' role="presentation" class="{childCls} {baseIconCls} {customIconCls} ','{baseIconCls}-<tpl if="leaf">leaf<tpl else><tpl if="expanded">parent-expanded<tpl else>parent<\/tpl><\/tpl> {iconCls}" ','<tpl if="icon">style="background-image:url({icon})"/><tpl else>><\/div><\/tpl>','<tpl if="href">','<a href="{href}" role="link" target="{hrefTarget}" class="{textCls} {childCls}">{value}<\/a>',"<tpl else>",'<span class="{textCls} {childCls}">{value}<\/span>',"<\/tpl>"].join("")}function ki(n){return function(t,i,r){t=yu(t,this);var u=r.get("url");return u&&r.get("urlAttributes").indexOf(n)!==-1&&(t=vu(t,u)),t}}function vu(n,t){return"<a href='"+t+"' target='_blank'>"+n+"<\/a>"}function yu(n,t){var i=t.searchField.getValue().trim();return i.length>0?t.strMarkRedPlus(i,n):n}function pu(n){function i(i,r){var u,f;r.getKey()==r.ENTER&&(u=i.getValue().trim(),u===""?(ot(n.store),t=u):u&&u!==t&&(f=function(){n.filterStore(u);t=u;Ext.getCmp("DictWind"+s).unmask()},Ext.getCmp("DictWind"+s).mask("Поиск"),setTimeout(f,1e3)))}var t="",r=s;Ext.apply(n,{store:h,columns:cu(n),dockedItems:[{xtype:"textfield",id:"dictionarySearchField"+s,dock:"top",emptyText:"Поиск",value:"",enableKeyEvents:!0,triggers:{clear:{cls:"x-form-clear-trigger",handler:"onClearTriggerClick",hidden:!1,scope:"this"},search:{cls:"x-form-search-trigger",weight:1,handler:"onSearchTriggerClick",scope:"this"}},onClearTriggerClick:function(){this.setValue();ot(n.store)},onSearchTriggerClick:function(){var i=this,r=function(){var r=i.getValue().trim();t=r;n.filterStore(r);Ext.getCmp("DictWind"+s).unmask()};Ext.getCmp("DictWind"+s).mask("Поиск");setTimeout(r,100)},listeners:{specialkey:i,render:function(n){this.searchField=n;n.focus(!1,10)},scope:n}}]});n.callParent(arguments)}function wu(){var n=u.attr("data-dict-name"),t,r,i;n==="Контрагенты"&&typeof isButtonExternalSystemShow!="undefined"&&isButtonExternalSystemShow.toLowerCase()==="true"&&st.unshift({text:"Поиск в смежных системах",cls:"dialogFindBtn",handler:function(){var n=$(".x-form-text[id^='dictionarySearchField']"),t;n.val()&&(n.val(""),ot(e.store));$(".x-form-search-trigger").closest(".x-form-item-body[id^='dictionarySearchField']").hide();tu();gt=!0;t=at?b.height-l.height-45:b.height-l.height-145;e.setHeight(t)}});l=Ext.create("Ext.panel.Panel",{id:"itemFormPanel-suppliers",height:220,bodyCls:"x-body x-webkit x-chrome",hidden:!0,autoDestroy:!1,layout:"container",buttons:[{text:"Найти",handler:function(){if(typeof ExtContractorManager!="undefined"){var n=ExtContractorManager(h,e,b);n.findExternalContractor()}else alert("Нет обработчика для поиска внешних контрагентов - необходимо проверить js файлы конфигурации")}},{text:"Отмена",cls:"on-external-search-cancel-button",handler:function(){$(".x-form-search-trigger").closest(".x-form-item-body[id^='dictionarySearchField']:hidden").show();var n=this.up("panel");$(n.ariaEl.dom).hide();n.setHidden(!0);e.setHeight(b.height-45);gt=!1;h.clearData();e.view.refresh();ui();e.reconfigure(h);e.view.refresh();at=!1;l.setHeight(l.height-100)}}]});y=Ext.create("Ext.panel.Panel",{id:"itemFormPanel"+s,minHeight:Math.min(350,ct.common.calc.getMinClientHeight()/2),height:555,rootVisible:!1,hideHeaders:!1,hidden:!0,layout:"container",bodyCls:"x-body x-webkit x-chrome",buttons:[{text:"Сохранить",handler:cr},{text:"Отмена",handler:function(){y.setHidden(!0);e.setVisible(!0)}}],autoScroll:!0});e=Ext.create("Ext.filteredTree");t=850;r=700;n==="Контрагенты"&&typeof isButtonExternalSystemShow!="undefined"&&isButtonExternalSystemShow.toLowerCase()==="true"&&(e.applyScrollable("vertical"),bt=t);i=n=="Контрагенты"?[l,e,y]:[e,y];b=Ext.create("widget.window",{title:n!=null&&n.length>0?n:"Выбор значения из словаря",header:{titleAlign:"center"},closable:!1,id:"DictWind"+s,closeAction:"destroy",maximizable:!0,width:bt,layout:{type:"vbox",align:"stretch"},monitorResize:!0,modal:!0,items:i,autoDestroy:!1,listeners:{close:tt,resize:function(n,t,i){if($("#editView").length>0||$("#registerView").length>0||$("#address-book-container").length>0||$("#build-report-form").length>0){t=Math.min(t,ct.common.calc.getMinClientWidth());n.setWidth(t);n.setHeight(i);var r=gt?i-l.height-45:n.height-45;e.setHeight(r);y&&y.setHeight(r)}},maximize:function(n){n.anchorTo("DictWind"+s,"bl-bl?",[0,0],!0,50,function(){})},restore:function(n){n.anchorTo(Ext.getBody(),"c-c",[0,0],!0,50,function(){})}}});b.show();w=$('[data-componentid="dictionarySearchField'+s+'"]');w&&w.prop("disabled",!0);bu();gu(e);ku(e,u,s)}function bu(){var n=e}function ku(n,t,i){var u=t,r=i;$(document).on("click",".edit-btn-"+r,function(t){t.preventDefault();du(t.target,n,u,r)})}function du(n,t,i){t.hide();var u=$(n).closest("table").first().attr("data-recordindex"),f=t.store.data.items===undefined?t.store.data.last.value[u].id:t.store.data.items[u].data.id,r=i.attr("data-edit-url");r=r+"&key="+f;hi(r)}function gu(n){var t=n.getView();Ext.create("Ext.tip.ToolTip",{target:t.getId(),delegate:t.cellSelector,renderTo:Ext.getBody(),listeners:{beforeshow:function(n){var t=$(n.triggerElement).find(".x-grid-cell-inner").text();if(t==null||$.trim(t).length===0)return!1;n.update(t)}}})}function nf(){Ext.define("Ext.grid.header.Container",{override:"Ext.grid.header.Container",sortAscText:"Сортировать по возрастанию",sortDescText:"Сортировать по убыванию"})}var d=$.Deferred(),h,e,y,l,b,a,rt,ut,u=$(n),wt,di,ft,st,gi,ht,o,ii=779,bt=800,kt,c=[],g={},w,f=[],v=!1,lt=!1,s,dt,p,at=!1,gt=!1,nt=[],ri=!1,vt="",ni={reader:{type:"json",root:"children",totalProperty:"virtualizeCount"},createStore:function(n,t){return Ext.create("Ext.data.Store",{model:"Dictionary",proxy:n,remoteFilter:!0,pageSize:t||200,buffered:!0,leadingBufferZone:t||200,autoLoad:!0,remoteGroup:!0,listeners:{load:function(n,t,i){var r=!1;i&&f.length>0&&(f.forEach(function(n){t.forEach(function(t){if(t.get(o.CodeKey)===n.get(o.CodeKey)){r=!0;var i=f.indexOf(n);i>-1&&(f[i]=t);t.set("checked",!0);t.modified={};e.view.refreshNode(t);e.view.focusRow(t)}})}),r||v||(typeof f[0]!="undefined"&&(typeof f[0].data!="undefined"?typeof n.data.map[1]!="undefined"&&(n.data.map[1].value[0].data=f[0].data):typeof n.data.map[1]!="undefined"&&(n.data.map[1].value[0].data=f[0])),f.forEach(function(n){t.forEach(function(t){if(t.get(o.CodeKey)===n.get(o.CodeKey)){var i=f.indexOf(n);i>-1&&(f[i]=t);t.set("checked",!0);t.modified={};try{e.view.refreshNode(t);e.view.focusRow(t)}catch(r){}}})})))}}})},panelType:"Ext.grid.Panel",columnXtype:"gridcolumn",chooseButtonHandler:function(){var n=this.up("grid");iu(n)}},nr={reader:"json",createStore:function(n){return Ext.create("Ext.data.TreeStore",{model:"Dictionary",proxy:n,remoteFilter:!0})},panelType:"Ext.tree.Panel",columnXtype:"treecolumn",chooseButtonHandler:function(){var n=this.up("treepanel");ru(n)}},dr=function(n,t,i,r,u){if(u.target.className.indexOf("x-tree-checkbox")==-1&&!u.target.classList.contains("x-tree-icon-edit")&&(t.get("enabled")==undefined||t.get("enabled")==!0)){var f=t.get("checked");t.set("checked",!f);yt(t,!f)}},gr=function(n,t){n&&(ri?n.cascadeBy(function(n){n.set("checked",t);yt(n)}):yt(n,t))};return ir(),d};
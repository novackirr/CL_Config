var UploadAttachment=function(){function l(){var u,l,v,f,e;console.info("Initialization of uploadAttachmentModalDialog.js");$("body").off("change",'input[type="file"]');$("body").on("change",'input[type="file"]',onFileEditorChange);if(n==null&&(u=$(".js-attachment-grid-containter"),t=u.closest("form"),i=$("#btn-ok_from_modal"),l=$(i).parents(".modal-dialog").length>0,v=window.location.pathname.toLowerCase().indexOf("/BasedOn".toLowerCase())!==-1,u.length!==0)){f=u.last();e=u.last().find("[name='DigitalSignature']").length>0;e&&(i.attr("disabled","disabled"),UploadAttachmentHelper.disableFileSelector(t),EDS.GetCertificates().then(function(){var n=EDS.TryToSelectDefaultCertificate();n?(i.removeAttr("disabled"),UploadAttachmentHelper.enableFileSelector(t)):r("Нет доступных сертификатов для подписи файлов, невозможно присоединить файлы.")}));a(u.last(),e);var o=UploadAttachmentHelper.getCategories(f),y=UploadAttachmentHelper.getColumnDefenitions(f),p=f.find(".js-attachmentsGrid"),w=f.find(".error-message"),c=null,b=$("#viewNavigationTabs li.active > a").contents().first(),k=b.text().trim();o.forEach(function(n){n.name===k&&(c=n)});l&&v?(n=new AttachmentGrid,n.init(p,y,o,w,c),n.onValidating=s,n.onRemoving=h,$(t).last().find("[name='attachmentFiles']").removeAttr("required")):typeof grids!="undefined"&&window.grids.length>0&&window.addTableRowAttachmentWasClicked?n=window.grids[0]:(n=new AttachmentGrid,n.init(p,y,o,w,c),n.onValidating=s,n.onRemoving=h)}}function a(n,f){i.unbind("click");i.on("click",function(i){setPreventDefault(i);var o=t.parsley();o.length>1&&(o=o[o.length-1]);window.addTableRowAttachmentWasClicked&&window.location.pathname.toLowerCase().indexOf("/Edit".toLowerCase())!==-1&&$("#actionDialog").is(":visible")?(c(),e(n,f).then(function(){typeof doNotReload!="undefined"&&window.doNotReload?(addRowAttachment(),$("#actionDialog").modal("hide"),window.doNotReload=!1,u()):window.location.reload()},function(n){n.responseText?r(n.responseText):r(n)})):o.whenValidate().done(function(){c();e(n,f).then(function(){if(typeof doNotReload!="undefined"&&window.doNotReload)addRowAttachment(),$("#actionDialog").modal("hide"),window.doNotReload=!1,u();else if(window.location.pathname.toLowerCase().indexOf("DocumentView".toLowerCase())!==-1){var n=window.location.pathname.split("/").pop();$.ajax({url:UploadAttachmentHelper.getBaseUrl()+"/Document/GetFilesTableDataSource?docKey="+n+"&originalUrl="+window.location.href,type:"GET",cache:!1}).then(function(n){for(var e,v,y,r,p,d=n.DataSourceNames,h=n.DataSources,g=n.VersionsDataSorces,nt=window.location.pathname.split("/").pop(),f=[],o=0;o<h.length;o++){var c=d[o],i=h[o].Data,l=g[o].Data,s=$("#viewNavigationTabs li[data-tabname='"+c+"'] > a"),tt=s.data("target"),a=$(tt+" div[data-grid-id^='files-table-'] > div"),t=a.dxDataGrid("instance");if(t){e=t.getDataSource().store();let n={tabName:c,element:a,ref:t,pages:t.pageCount(),rows:0,page:t.pageIndex(),rowPerPage:t.pageSize(),items:[]};if(e._array.length!=i.length){for(v=i.length-e._array.length,y=l.length,r=v;r>0;r--)n.items.push(l[y-r]);for(r=e._array.length;r<i.length;r++)p=i[r],e._array.push(p);n.rows=i.length;(n.page!=n.pages-1||n.pages*n.rowPerPage<i.length)&&(t.pageIndex(0),t.pageSize(i.length),t.option("paging.enabled","false"),n.page=0,n.pages=1,n.rowPerPage=i.length);f.push(n);t.refresh().done(function(){for(var t,e,r,u,o,s,h,n,i=0;i<f.length;i++)if(f[i].items.length!=0){for(t=f[i],e=f[i].element,t.ref.collapseAll(-1),r=[],n=0;n<t.items.length;n++)u=t.ref.getKeyByRowIndex(t.rows-(t.pages-1)*t.rowPerPage-(n+1)),r.push(u),t.ref.expandRow(u);for(o=e.find("div[data-grid-id^='files-version-table-'] > div"),n=0;n<t.items.length;n++)s=$(o[n]).dxDataGrid("instance"),h=s.getDataSource().store(),h._array.push(t.items[n]);for(n=0;n<r.length;n++)t.ref.collapseRow(r[n]);f[i].items=[]}});var w=e._array.length,b=w?w:"",k=s.children(".badge");k.length?k.text(b):s.append("<span><\/span><span class='badge'>"+b+"<\/span>")}}}window.docChangeObserver&&window.docChangeObserver.doHashRefresh(nt);$("#actionDialog").modal("hide");u();window.ct.common.routesGrid.refresh()})}else window.location.reload()},function(n){n.responseText?r(n.responseText):r(n)})})})}function e(n,t){var i=jQuery.Deferred();return v(n,t).then(function(n){f?f().then(function(){resetActionsCache();i.resolve()},function(t){o(n).always(function(){i.reject(t)})}):(resetActionsCache(),i.resolve())},function(n){i.reject(n)}),i.promise()}function v(i,r){var u=jQuery.Deferred(),f=new UploadAttachmentService;return n.isRowsValid()?(f.upload(t).then(function(n){n||u.resolve();r?p(i,n).then(function(){u.resolve(n)},function(t){o(n).always(function(){u.reject(t)})}):u.resolve(n)},function(n){u.reject(n)}),u.promise()):(u.reject("Заполните обязательные поля"),u.promise())}function o(n){var t=jQuery.Deferred(),i=$.when();return $.each(n,function(n,r){i=i.then(function(){return y(n,r)}).then(function(){console.info("Документ с ключом "+n+" обработан.")},function(n){var i=n.responseText?n.responseText:n;t.reject(i)})}),i.then(function(){t.resolve()},function(n){t.resolve(n)}),t.promise()}function y(n,t){var r=jQuery.Deferred(),u=UploadAttachmentHelper.getBaseUrl()+"/ContextAction/DeleteAttachmentHandler",i=$.when();return $.each(t,function(t,r){var f=new FormData;f.append("uniqueIds",n+"/"+r);i=i.then(function(){return $.ajax({url:u,type:"POST",mimeType:"multipart/form-data",cache:!1,data:f,contentType:!1,cache:!1,processData:!1})}).then(function(){},function(n){console.info(n)})}),i.always(function(){r.resolve()}),r.promise()}function p(n,t){var i=jQuery.Deferred(),r=$.when(),u=new SignAttachmentService(n);return $.each(t,function(n,t){r=r.then(function(){return u.signDocumentFiles(n,t)}).then(function(){console.info("Файлы документа с ключом "+n+" подписаны.")},function(n){var t=n.responseText?n.responseText:n;i.reject(t)})}),r.then(function(){i.resolve()},function(n){i.reject(n)}),i.promise()}function s(){n.isValid?i.removeAttr("disabled"):i.attr("disabled","disabled")}function h(n){removeAjaxFile(t[0],n);var i=t.find("input[type='file']"),r=!getAjaxFiles(t).length;i.prop("required",i.attr("data-required").toLowerCase()=="true"&&r);i.closest(".file-drop-area").toggleClass("empty",r)}function w(t,i,r){n.addFile(i,r).then(function(){})}function b(t){return t?(t=parseInt(t),n.getFileProps(t)):null}function r(n){if(u(),n!=="Имя файла не может быть пустым."){var t=$("#actionDialog").find(".modal-errors-wrapper");t.show();t.html(n)}}function c(){t.find("[type='submit']").prop("disabled",!0);$("#actionDialog").find(".btn-submit").prop("disabled",!0);$("#actionDialog").find(".modal-loading-wrapper").show()}function u(){t.find("[type='submit']").prop("disabled",!1);$("#actionDialog").find(".btn-submit").prop("disabled",!1);$("#actionDialog").find(".modal-loading-wrapper").hide()}var n=null,f=null,i=null,t=null;return{init:l,addFile:w,getFileProps:b,setPostUploadAction:function(n){f=n}}}();(function(){$(document).ready(function(){UploadAttachment.init()})})();
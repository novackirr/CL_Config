var UploadAttachment=function(){function e(){var u,e;console.info("Initialization of uploadAttachmentOnRegister.js");$("body").off("change",'input[type="file"]');$("body").on("change",'input[type="file"]',onFileEditorChange);n.length>0||(u=$(".js-attachment-grid-containter"),u.length!==0)&&(t=u.closest("form"),i=t.find("a.btn:contains('Сохранить')"),e=u.first().find("[name='DigitalSignature']").length>0,e&&o(u),$.each(u,function(t,i){var u=$(i),s=u.find(".error-message"),o;e&&(UploadAttachmentHelper.disableFileSelector(u),EDS.GetCertificates(u,f(u)).then(function(){var n=EDS.TryToSelectDefaultCertificate(u);n?UploadAttachmentHelper.enableFileSelector(u):(UploadAttachmentHelper.disableFileSelector(u),s.removeClass("hide"),s.text("Нет доступных сертификатов для подписи файлов, невозможно присоединить файлы."))}));var h=UploadAttachmentHelper.getCategories(u),l=UploadAttachmentHelper.getColumnDefenitions(u),y=u.find(".js-attachmentsGrid"),p=u.find("input[type='file']");p.attr(r,t);var c=null,w=$("#viewNavigationTabs li.active > a").contents().first(),b=w.text().trim();h.forEach(function(n){n.name===b&&(c=n)});o=new AttachmentGrid;o.init(y,l,h,s,c);o.onValidating=a;o.onRemoving=v;n.push(o)}),window.grids=n)}function o(n){t.on("afterFormSubmit",function(t,i){var r=jQuery.Deferred();return s(i.docKey).then(function(t){t?h(i.docKey,n,t).then(function(){r.resolve()},function(n){console.info(n);u(i.docKey).always(function(){r.reject(n)})}):r.resolve()},function(){console.info(error);u(i.docKey).always(function(){r.reject(error)})}),r.promise()})}function s(n){var t=jQuery.Deferred(),i=UploadAttachmentHelper.getBaseUrl(),r;return i+="/ContextAction/GetAttachmentsInfo?docKey="+n+"&withoutSign=true",r=$.ajax({url:i,type:"GET",contentType:!1,cache:!1,processData:!1}),r.then(function(n){var i,r,u;n&&n.trim()!==""?(i=JSON.parse(n),i.status==="OK"&&(r=JSON.parse(i.responseMessage),u=l(r),t.resolve(u))):t.resolve()},function(n){console.info(n);t.reject(n)}),t.promise()}function h(n,t,i){var r=jQuery.Deferred(),u=$.when();return $.each(t,function(t,e){var o=$(e),s=f(o),h=i[s];u=u.then(function(){return c(o,n,h)}).then(function(){console.info("Подписан файлы в категории "+s+".")},function(n){n&&r.reject(n)})}),u.then(function(){r.resolve()},function(n){r.reject(n?n:"")}),r.promise()}function c(n,t,i){var u,r;return i&&i.length>0?(u=new SignAttachmentService(n),u.signDocumentFiles(t,i)):(r=jQuery.Deferred(),r.resolve(),r.promise())}function u(n){var i=UploadAttachmentHelper.getBaseUrl()+"/ContextAction/DeleteDocumentHandler",t=new FormData;return t.append("uniqueIds",n),$.ajax({url:i,type:"POST",mimeType:"multipart/form-data",cache:!1,data:t,contentType:!1,cache:!1,processData:!1})}function f(n){var t=n.parents(".tab-pane");return $("[data-target='#"+t.attr("id")+"']").text()}function l(n){for(var t,u=n.length,i={},r=0;r<n.length;r++)t=n[r],i[t.category]?i[t.category].push(t.key):i[t.category]=[t.key];return i}function a(){for(var u,f=n.length,r=!0,t=0;t<f;t++)if(u=n[t],!u.isValid){r=!1;break}r?i.removeAttr("disabled"):i.attr("disabled","disabled")}function v(n,i){var r,u,f,e;removeAjaxFile(t[0],n);r=t.find("input[type='file']");u=!getAjaxFiles(t).length;r.prop("required",r.attr("data-required").toLowerCase()=="true"&&u);r.closest(".file-drop-area").toggleClass("empty",u);i&&(f=window.location.pathname.toLowerCase().indexOf("/BasedOn".toLowerCase())!==-1,f&&(e=$(".table-edit-column input[name*='-attachment_key-'][value='"+i+"']").closest(".table-edit-row").find(".delete-table-row-attachment").children(":first"),deleteTableRowAttachment(e,null,!0)))}function y(t,i,u){var f=t.attr(r),e=parseInt(f);n[e].addFile(i,u)}function p(t){var u,i,f,r;if(t){for(t=parseInt(t),u=n.length,i=0;i<u;i++)if(f=n[i],r=f.getFileProps(t),r)return r;return null}}var n=[],r="data-attachment-grid-index",i=null,t=null;return{init:e,addFile:y,getFileProps:p}}();(function(){$(document).ready(function(){UploadAttachment.init()})})();